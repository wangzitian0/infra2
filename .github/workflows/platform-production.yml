name: Platform Production Deployment

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
      staging_tag:
        description: 'Staging tag to promote (e.g., v1.2.5)'
        required: true

permissions:
  contents: write

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: inputs.confirm != 'deploy'
        run: |
          echo "❌ Deployment cancelled: confirmation not provided"
          exit 1
      
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate staging tag exists
        run: |
          if ! git tag | grep -q "^${{ inputs.staging_tag }}$"; then
            echo "❌ Tag ${{ inputs.staging_tag }} does not exist"
            exit 1
          fi
          echo "✅ Tag ${{ inputs.staging_tag }} exists"
      
      - name: Create production tag
        id: prod_tag
        run: |
          STAGING_TAG="${{ inputs.staging_tag }}"
          
          MAJOR=$(echo $STAGING_TAG | cut -d. -f1 | sed 's/v//')
          MINOR=$(echo $STAGING_TAG | cut -d. -f2)
          
          NEW_MINOR=$((MINOR + 1))
          PROD_TAG="v${MAJOR}.${NEW_MINOR}.0"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$PROD_TAG" "$STAGING_TAG" -m "Production release $PROD_TAG (from $STAGING_TAG)"
          git push origin "$PROD_TAG"
          
          echo "tag=${PROD_TAG}" >> $GITHUB_OUTPUT
          echo "✅ Created production tag: $PROD_TAG"
      
      - name: Trigger IaC Runner deployment
        env:
          WEBHOOK_SECRET: ${{ secrets.IAC_WEBHOOK_SECRET }}
        run: |
          PROD_TAG="${{ steps.prod_tag.outputs.tag }}"
          STAGING_TAG="${{ inputs.staging_tag }}"
          
          PAYLOAD=$(cat <<EOF
          {
            "env": "production",
            "tag": "$PROD_TAG",
            "staging_tag": "$STAGING_TAG",
            "triggered_by": "${{ github.actor }}"
          }
          EOF
          )
          
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | awk '{print $2}')
          
          curl -X POST https://iac.zitian.party/deploy \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD"
          
          echo "✅ Triggered production deployment: $PROD_TAG"
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.prod_tag.outputs.tag }}
          release_name: Platform ${{ steps.prod_tag.outputs.tag }}
          body: |
            Production release promoted from staging tag: ${{ inputs.staging_tag }}
            
            Deployed by: ${{ github.actor }}
          draft: false
          prerelease: false
