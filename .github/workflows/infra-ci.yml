name: Infrastructure CI

on:
  pull_request:
    paths:
      - 'bootstrap/**'
      - 'platform/**'
      - 'finance_report/**'
      - 'libs/**'
      - '.github/workflows/infra-ci.yml'
  push:
    branches: [main]
    paths:
      - 'bootstrap/**'
      - 'platform/**'
      - 'finance_report/**'
      - 'libs/**'

permissions:
  contents: read

jobs:
  validate-compose:
    name: Validate Compose Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate all compose.yaml files
        run: |
          set -e
          echo "üîç Validating compose files..."
          find . -name "compose.yaml" -type f | while read -r file; do
            echo "Validating: $file"
            docker compose -f "$file" config > /dev/null
          done
          echo "‚úÖ All compose files are valid"
        env:
          DATA_PATH: /tmp/infra2-data

  test-deployer-logic:
    name: Test Deployer Hash Logic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          cd ${{ github.workspace }}
          uv pip install --system invoke httpx python-dotenv rich

      - name: Test config hash idempotency
        run: |
          cd ${{ github.workspace }}
          python -c "
          import sys
          sys.path.insert(0, 'libs')
          from deployer import _compute_config_hash
          
          # Test hash stability with different order
          hash1 = _compute_config_hash('test: true', {'A': '1', 'B': '2'})
          hash2 = _compute_config_hash('test: true', {'B': '2', 'A': '1'})
          assert hash1 == hash2, f'Hash not stable! {hash1} != {hash2}'
          
          # Test hash changes when content changes
          hash3 = _compute_config_hash('test: false', {'A': '1', 'B': '2'})
          assert hash1 != hash3, 'Hash should change with content'
          
          print('‚úÖ Config hash idempotency verified')
          "

      - name: Test service discovery
        run: |
          cd ${{ github.workspace }}
          python -c "
          import sys
          sys.path.insert(0, 'libs')
          from deployer import discover_services
          
          services = discover_services()
          print(f'Discovered {len(services)} services:')
          for key, task in sorted(services.items()):
            print(f'  {key} -> {task}')
          
          assert len(services) > 0, 'Should discover at least one service'
          print('‚úÖ Service discovery working')
          "

  validate-vault-agent:
    name: Validate Vault Agent Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check vault-agent.hcl has required settings
        run: |
          set -e
          echo "üîç Checking vault-agent.hcl files..."
          failed=0
          for file in $(find . -name "vault-agent.hcl" -type f); do
            echo "Checking: $file"
            if ! grep -q "exit_on_err = true" "$file"; then
              echo "‚ùå Missing 'exit_on_err = true' in $file"
              failed=1
            fi
            if ! grep -q "exit_on_retry_failure = true" "$file"; then
              echo "‚ùå Missing 'exit_on_retry_failure = true' in $file"
              failed=1
            fi
          done
          if [ $failed -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è  vault-agent.hcl files must have exit settings to prevent"
            echo "   zombie containers when tokens expire. Run:"
            echo "   python scripts/add_vault_agent_exit_on_failure.py"
            exit 1
          fi
          echo "‚úÖ All vault-agent.hcl files have required exit settings"

  validate-vault-policy:
    name: Validate Vault Policy Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate vault-policy.hcl syntax
        run: |
          set -e
          echo "üîç Validating vault-policy.hcl files..."
          failed=0
          for file in $(find . -name "vault-policy.hcl" -type f); do
            echo "Checking: $file"
            # Basic HCL syntax validation using vault policy fmt
            # The command formats the file and exits 0 on valid HCL
            # Use --cap-add=IPC_LOCK to avoid Vault's IPC_LOCK warning
            if ! docker run --rm --cap-add=IPC_LOCK -v "$(pwd):/workspace:ro" -w /workspace \
              hashicorp/vault:1.15 sh -c "vault policy fmt /dev/stdin < \"$file\" > /dev/null 2>&1"; then
              echo "‚ùå Invalid HCL syntax in $file"
              failed=1
            else
              echo "  ‚úÖ Valid"
            fi
          done
          if [ $failed -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è  Fix HCL syntax errors before merging."
            exit 1
          fi
          echo "‚úÖ All vault-policy.hcl files have valid syntax"

  validate-deployers:
    name: Validate Deployer Classes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          cd ${{ github.workspace }}
          uv pip install --system invoke httpx python-dotenv rich

      - name: Validate all deploy.py files
        run: |
          cd ${{ github.workspace }}
          python -c "
          import sys
          import importlib.util
          from pathlib import Path

          sys.path.insert(0, '.')

          failed = []
          deploy_files = list(Path('.').rglob('deploy.py'))

          print(f'Found {len(deploy_files)} deploy.py files')

          for deploy_file in deploy_files:
            # Skip playground and tests
            if 'playground' in str(deploy_file) or 'test' in str(deploy_file):
              continue

            print(f'Validating: {deploy_file}')
            try:
              # Load the module
              spec = importlib.util.spec_from_file_location('deploy', deploy_file)
              module = importlib.util.module_from_spec(spec)

              # Import libs.deployer to get Deployer class
              from libs.deployer import Deployer

              # Execute the module
              spec.loader.exec_module(module)

              # Find Deployer subclass
              deployer_cls = None
              for name, obj in vars(module).items():
                if isinstance(obj, type) and issubclass(obj, Deployer) and obj is not Deployer:
                  deployer_cls = obj
                  break

              if deployer_cls:
                # Validate required attributes
                errors = []
                if not deployer_cls.service:
                  errors.append('missing service name')
                if not deployer_cls.compose_path:
                  errors.append('missing compose_path')
                # data_path is optional for stateless services (e.g., app containers)

                # Validate compose_path exists
                compose_path = Path(deployer_cls.compose_path)
                if not compose_path.exists():
                  errors.append(f'compose file not found: {deployer_cls.compose_path}')

                if errors:
                  failed.append((deploy_file, errors))
                  print(f'  ‚ùå {deploy_file}: {errors}')
                else:
                  print(f'  ‚úÖ {deployer_cls.__name__}: service={deployer_cls.service}')
              else:
                print(f'  ‚ö†Ô∏è No Deployer subclass found (may be OK for bootstrap)')

            except Exception as e:
              failed.append((deploy_file, [str(e)]))
              print(f'  ‚ùå {deploy_file}: {e}')

          if failed:
            print(f'\\n‚ùå {len(failed)} deploy.py files have errors')
            sys.exit(1)

          print(f'\\n‚úÖ All deploy.py files validated')
          "

  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check libs/ bootstrap/ platform/ finance_report/ tools/

      - name: Determine changed Python files
        id: changed-python
        run: |
          base_ref="${{ github.base_ref }}"
          if [ -z "$base_ref" ]; then
            base_ref="main"
          fi
          git fetch origin "$base_ref" --depth=1
          files=$(git diff --name-only "origin/$base_ref...HEAD" -- libs bootstrap platform finance_report tools | grep -E '\.py$' || true)
          files="${files//$'\n'/ }"
          echo "files=$files" >> "$GITHUB_OUTPUT"

      - name: Run ruff format check
        if: steps.changed-python.outputs.files != ''
        run: ruff format --check ${{ steps.changed-python.outputs.files }}
