services:
  iac-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: iac-runner
    restart: unless-stopped
    environment:
      # Webhook config
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - WEBHOOK_PORT=8080
      # Git config (required)
      - GIT_REPO_URL=${GIT_REPO_URL}
      - GIT_BRANCH=${GIT_BRANCH:-main}
      # Vault config (for invoke tasks)
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_APP_TOKEN=${VAULT_APP_TOKEN}
      # Dokploy config
      - DOKPLOY_API_KEY=${DOKPLOY_API_KEY}
      - INTERNAL_DOMAIN=${INTERNAL_DOMAIN}
      # Environment
      - ENV=${ENV:-production}
      - PROJECT=${PROJECT:-platform}
    volumes:
      # Persistent workspace for git clone
      - ${DATA_PATH:-/data/bootstrap/iac-runner}/workspace:/workspace
      # SSH key for VPS access (mount only specific key)
      - ${SSH_KEY_PATH:-/root/.ssh/id_ed25519}:/root/.ssh/id_ed25519:ro
      - ${SSH_KEY_PATH:-/root/.ssh/id_ed25519}.pub:/root/.ssh/id_ed25519.pub:ro
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.iac-runner.rule=Host(`iac.${INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.iac-runner.entrypoints=websecure"
      - "traefik.http.routers.iac-runner.tls.certResolver=letsencrypt"
      - "traefik.http.services.iac-runner.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  dokploy-network:
    external: true
