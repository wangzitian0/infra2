services:
  iac-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: iac-runner
    restart: unless-stopped
    environment:
      # Webhook config
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - WEBHOOK_PORT=8080
      # Git config
      - GIT_REPO_URL=https://github.com/wangzitian0/infra2.git
      - GIT_BRANCH=main
      # Vault config (for invoke tasks)
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
      # Dokploy config
      - DOKPLOY_API_KEY=${DOKPLOY_API_KEY}
      - INTERNAL_DOMAIN=${INTERNAL_DOMAIN}
      # Environment
      - ENV=${ENV:-production}
      - PROJECT=${PROJECT:-platform}
    volumes:
      # Mount docker socket for container operations
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Persistent workspace for git clone
      - ${DATA_PATH:-/data/bootstrap/iac-runner}/workspace:/workspace
      # SSH keys for VPS access
      - /root/.ssh:/root/.ssh:ro
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.iac-runner.rule=Host(`iac.${INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.iac-runner.entrypoints=websecure"
      - "traefik.http.routers.iac-runner.tls.certResolver=letsencrypt"
      - "traefik.http.services.iac-runner.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  dokploy-network:
    external: true
