services:
  vault-agent:
    image: hashicorp/vault:1.15
    container_name: iac-runner-vault-agent
    restart: always
    entrypoint:
      - sh
      - -c
      - |
        echo "$$VAULT_APP_TOKEN" > /vault/token
        exec vault agent -config=/etc/vault/vault-agent.hcl
    environment:
      VAULT_ADDR: ${VAULT_ADDR}
      VAULT_APP_TOKEN: ${VAULT_APP_TOKEN:-}
      ENV: ${ENV:-production}
    volumes:
      - ./vault-agent.hcl:/etc/vault/vault-agent.hcl:ro
      - ./secrets.ctmpl:/etc/vault/secrets.ctmpl:ro
      - secrets:/vault/secrets
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "test", "-f", "/vault/secrets/.env"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  iac-runner:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - GIT_SHA=${GIT_SHA:-latest}
    # Always rebuild from source when deploying (no image caching)
    # This ensures webhook_server.py and other source files are always up-to-date
    pull_policy: build
    image: bootstrap-iac_runner-bkewyn-iac-runner:${GIT_SHA:-latest}
    container_name: iac-runner
    restart: unless-stopped
    depends_on:
      - vault-agent
    entrypoint:
      - sh
      - -c
      - |
        set -e
        
        echo "Waiting for secrets file..."
        timeout=60
        while [ ! -f /secrets/.env ] && [ $$timeout -gt 0 ]; do
          sleep 1
          timeout=$$((timeout - 1))
        done
        
        if [ ! -f /secrets/.env ]; then
          echo "ERROR: Secrets file not found after 60s"
          exit 1
        fi
        
        if [ ! -s /secrets/.env ]; then
          echo "ERROR: Secrets file is empty"
          exit 1
        fi
        
        set -a
        . /secrets/.env
        set +a
        
        if [ -z "$$WEBHOOK_SECRET" ]; then
          echo "ERROR: WEBHOOK_SECRET not set in secrets"
          exit 1
        fi
        
        if [ -z "$$GIT_REPO_URL" ]; then
          echo "ERROR: GIT_REPO_URL not set in secrets"
          exit 1
        fi
        
        echo "Secrets validated successfully"
        
        mkdir -p /root/.ssh_runtime
        if [ -f /root/.ssh/id_ed25519 ]; then
          cp /root/.ssh/id_ed25519 /root/.ssh_runtime/id_ed25519
          chmod 600 /root/.ssh_runtime/id_ed25519
          if [ -f /root/.ssh/id_ed25519.pub ]; then
            cp /root/.ssh/id_ed25519.pub /root/.ssh_runtime/id_ed25519.pub
          fi
          cat > /root/.ssh/config <<EOF
        Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            IdentityFile /root/.ssh_runtime/id_ed25519
            LogLevel ERROR
        EOF
          chmod 600 /root/.ssh/config
          echo "SSH key configured"
        else
          echo "WARNING: SSH key not found, remote operations may fail"
        fi
        
        echo "Starting gunicorn with 1 worker, 4 threads..."
        exec gunicorn -w 1 --threads 4 -b 0.0.0.0:8080 --timeout 120 webhook_server:app
    environment:
      - WEBHOOK_PORT=8080
      - GIT_BRANCH=${GIT_BRANCH:-main}
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_APP_TOKEN=${VAULT_APP_TOKEN:-}
      - DOKPLOY_API_KEY=${DOKPLOY_API_KEY:-}
      - INTERNAL_DOMAIN=${INTERNAL_DOMAIN}
      - VPS_HOST=${VPS_HOST:-}
      - ENV=${ENV:-production}
      - PROJECT=${PROJECT:-platform}
      - DEPLOY_TIMEOUT=${DEPLOY_TIMEOUT:-600}
      - BUILD_CACHE_BUST=v4
    volumes:
      - secrets:/secrets:ro
      - ${DATA_PATH:-/data/bootstrap/iac-runner}/workspace:/workspace
      - ${SSH_KEY_PATH:-/root/.ssh/id_ed25519}:/root/.ssh/id_ed25519:ro
      - ${SSH_KEY_PATH:-/root/.ssh/id_ed25519}.pub:/root/.ssh/id_ed25519.pub:ro
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.iac-runner.rule=Host(`iac.${INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.iac-runner.entrypoints=websecure"
      - "traefik.http.routers.iac-runner.tls.certResolver=letsencrypt"
      - "traefik.http.services.iac-runner.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    healthcheck:
      test: ["CMD", "test", "-f", "/vault/secrets/.env"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s


volumes:
  secrets:
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=10m,mode=0755"

networks:
  dokploy-network:
    external: true
