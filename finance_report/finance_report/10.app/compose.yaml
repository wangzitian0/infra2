# Finance Report Production Deployment
#
# IMPORTANT: This compose file runs database migrations on container startup.
#
# Deployment Considerations:
# - Migrations run automatically before the application starts
# - Alembic uses database locks to prevent concurrent migration conflicts
# - For zero-downtime deployments, ensure migrations are backward-compatible
# - Scale backend to 1 replica during deployments to avoid migration contention
# - Use 'docker compose up -d --no-deps --scale backend=1 backend' for updates
#
# Migration Safety:
# - Failed migrations prevent container startup (fail-fast)
# - Retry logic handles transient PostgreSQL connection issues
# - Healthcheck by default allows up to 180s for migration + startup time (configurable via BACKEND_HEALTHCHECK_START_PERIOD)
#
services:
  vault-agent:
    image: hashicorp/vault:1.15
    container_name: finance_report-app-vault-agent${ENV_SUFFIX}
    restart: always
    entrypoint:
      - sh
      - -c
      - |
        echo "$$VAULT_APP_TOKEN" > /vault/token
        exec vault agent -config=/etc/vault/vault-agent.hcl
    environment:
      VAULT_ADDR: ${VAULT_ADDR}
      VAULT_APP_TOKEN: ${VAULT_APP_TOKEN:-}
      ENV: ${ENV}
      IAC_CONFIG_HASH: ${IAC_CONFIG_HASH:-}
    healthcheck:
      test: ["CMD", "test", "-f", "/vault/secrets/.env"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 10s
    volumes:
      - ./vault-agent.hcl:/etc/vault/vault-agent.hcl:ro
      - ./secrets.ctmpl:/etc/vault/secrets.ctmpl:ro
      - secrets:/vault/secrets
    networks:
      - dokploy-network

    healthcheck:
      test: ["CMD", "test", "-f", "/vault/secrets/.env"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  backend:
    image: ghcr.io/wangzitian0/finance_report-backend:${IMAGE_TAG:-latest}
    pull_policy: always
    container_name: finance_report-backend${ENV_SUFFIX}
    restart: always
    depends_on:
      vault-agent:
        condition: service_healthy
    entrypoint:
      - sh
      - -c
      - |
        # Ensure we're in the app directory and set PYTHONPATH for alembic
        cd /app
        export PYTHONPATH=/app

        # Wait for secrets file to be rendered by vault-agent
        echo "üîç [CHECKPOINT-1] Waiting for Vault secrets to be rendered..."
        while [ ! -f /secrets/.env ]; do
          echo "  ‚è≥ Secrets not ready yet, retrying..."
          sleep 1
        done
        echo "‚úÖ [CHECKPOINT-1] Secrets file ready at /secrets/.env"
        
        set -a
        . /secrets/.env
        set +a

        # Run database migrations with retry logic
        # Retries handle cases where PostgreSQL might not be fully ready
        # Total retry time (~50s) fits within healthcheck start_period (60s)
        echo "üîç [CHECKPOINT-2] Starting database migrations..."
        max_retries=10
        retry_interval=5
        attempt=1

        until alembic upgrade head; do
          if [ "$$attempt" -ge "$$max_retries" ]; then
            echo "‚ùå [CHECKPOINT-2] CRITICAL: Migrations failed after $$attempt attempts"
            echo "  Possible causes: DB not reachable, migration syntax error, connection string wrong"
            exit 1
          fi
          echo "  ‚ö†Ô∏è  Migration attempt $$attempt/$$max_retries failed. Retrying in $$retry_interval seconds..."
          attempt=$$((attempt + 1))
          sleep $$retry_interval
        done

        echo "‚úÖ [CHECKPOINT-2] Migrations completed successfully"
        echo "üîç [CHECKPOINT-3] Starting uvicorn application server on port 8000..."
        exec uvicorn src.main:app --host 0.0.0.0 --port 8000
    environment:
      DEBUG: ${DEBUG:-false}
      # NOTE:
      # - This S3_PUBLIC_ENDPOINT is intentionally configured only for the backend.
      # - All S3 access from the application (including the browser/frontend) is
      #   performed via the backend API, so the frontend does not need this variable.
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT:-}
      IAC_CONFIG_HASH: ${IAC_CONFIG_HASH:-}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      start_period: ${BACKEND_HEALTHCHECK_START_PERIOD:-60s}
      interval: 10s
      retries: 3
      timeout: 5s
    volumes:
      - secrets:/secrets:ro
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.finance-report-api${ENV_DOMAIN_SUFFIX}.rule=Host(`report${ENV_DOMAIN_SUFFIX}.${INTERNAL_DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.finance-report-api${ENV_DOMAIN_SUFFIX}.entrypoints=websecure"
      - "traefik.http.routers.finance-report-api${ENV_DOMAIN_SUFFIX}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.finance-report-api${ENV_DOMAIN_SUFFIX}.service=finance-report-api${ENV_DOMAIN_SUFFIX}"
      - "traefik.http.services.finance-report-api${ENV_DOMAIN_SUFFIX}.loadbalancer.server.port=8000"
      # Strip /api prefix before forwarding to backend
      - "traefik.http.middlewares.finance-report-api-strip${ENV_DOMAIN_SUFFIX}.stripprefix.prefixes=/api"
      - "traefik.http.routers.finance-report-api${ENV_DOMAIN_SUFFIX}.middlewares=finance-report-api-strip${ENV_DOMAIN_SUFFIX}@docker"

  frontend:
    image: ghcr.io/wangzitian0/finance_report-frontend:${IMAGE_TAG:-latest}
    pull_policy: always
    container_name: finance_report-frontend${ENV_SUFFIX}
    restart: always
    depends_on:
      backend:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_URL: https://report${ENV_DOMAIN_SUFFIX}.${INTERNAL_DOMAIN}/api
      NEXT_PUBLIC_APP_URL: https://report${ENV_DOMAIN_SUFFIX}.${INTERNAL_DOMAIN}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000" ]
      start_period: 30s
      interval: 30s
      retries: 5
      timeout: 10s
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.finance-report-web${ENV_DOMAIN_SUFFIX}.rule=Host(`report${ENV_DOMAIN_SUFFIX}.${INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.finance-report-web${ENV_DOMAIN_SUFFIX}.entrypoints=websecure"
      - "traefik.http.routers.finance-report-web${ENV_DOMAIN_SUFFIX}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.finance-report-web${ENV_DOMAIN_SUFFIX}.service=finance-report-web${ENV_DOMAIN_SUFFIX}"
      - "traefik.http.services.finance-report-web${ENV_DOMAIN_SUFFIX}.loadbalancer.server.port=3000"
      # Lower priority than API route
      - "traefik.http.routers.finance-report-web${ENV_DOMAIN_SUFFIX}.priority=1"

volumes:
  secrets:
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=10m,mode=0755"

networks:
  dokploy-network:
    external: true
