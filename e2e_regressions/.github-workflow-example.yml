# Example GitHub Actions workflow for E2E regression tests
#
# Place this in .github/workflows/e2e-tests.yml to enable automatic testing
# after deployment

name: E2E Regression Tests

on:
  # è§¦å‘æ—¶æœºï¼šmerge åˆ° main åï¼ˆæ­¤æ—¶ Digger apply å·²å®Œæˆï¼‰
  push:
    branches: [main]
    paths:
      - '2.platform/**'      # L2 Platform
      - 'envs/*/3.data/**'   # L3 Data
      - '4.apps/**'          # L4 Apps
      - '.github/workflows/e2e-tests.yml'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆè°ƒè¯•ç”¨ï¼‰
  workflow_dispatch:

env:
  PORTAL_URL: ${{ secrets.PORTAL_URL }}
  SSO_URL: ${{ secrets.SSO_URL }}
  VAULT_URL: ${{ secrets.VAULT_URL }}
  DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
  TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
  TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}

jobs:
  # ğŸŸ¨ Layer 2: Readiness (èµ„æºå°±ç»ªæ£€æŸ¥)
  # è§¦å‘æ—¶æœºï¼šmerge åˆ° main æ—¶ï¼Œæ­¤æ—¶ Digger apply å·²å®Œæˆ
  post-apply-readiness:
    name: Wait for Resources Ready
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Wait for Vault
        run: |
          kubectl wait --for=condition=ready pod \
            -l app=vault -n platform --timeout=5m

      - name: Wait for PostgreSQL
        run: |
          kubectl wait --for=condition=ready pod \
            -l app=postgres -n data-prod --timeout=5m

      - name: Wait for Redis
        run: |
          kubectl wait --for=condition=ready pod \
            -l app=redis -n data-prod --timeout=5m

      - name: Wait for Portal
        run: |
          kubectl wait --for=condition=ready pod \
            -l app=homer -n platform --timeout=5m

  # ğŸŸª Layer 3: E2E Smoke Tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: post-apply-readiness
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Install dependencies
        working-directory: e2e_regressions
        run: uv sync

      - name: Run smoke tests
        working-directory: e2e_regressions
        run: uv run pytest -m smoke --tb=short -v

  # å…¶ä»–å¯é€‰æµ‹è¯•ï¼ˆä»…åœ¨çƒŸé›¾æµ‹è¯•é€šè¿‡æ—¶è¿è¡Œï¼‰
  platform-tests:
    name: Platform Service Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: needs.smoke-tests.result == 'success'
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Install dependencies
        working-directory: e2e_regressions
        run: uv sync

      - name: Run platform tests
        working-directory: e2e_regressions
        run: uv run pytest -m platform --tb=short -v

  sso-tests:
    name: SSO/Portal Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: needs.smoke-tests.result == 'success'
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Install dependencies
        working-directory: e2e_regressions
        run: uv sync

      - name: Run SSO tests
        working-directory: e2e_regressions
        run: uv run pytest -m sso --tb=short -v

  database-tests:
    name: Database Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: needs.smoke-tests.result == 'success'
    timeout-minutes: 15

    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      CLICKHOUSE_HOST: ${{ secrets.CLICKHOUSE_HOST }}
      CLICKHOUSE_PORT: ${{ secrets.CLICKHOUSE_PORT }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Install dependencies
        working-directory: e2e_regressions
        run: uv sync

      - name: Run database tests
        working-directory: e2e_regressions
        run: uv run pytest -m database --tb=short -v

  # ğŸ“Š æœ€ç»ˆæŠ¥å‘Šï¼šæˆåŠŸ/å¤±è´¥æ ‡è®°
  deployment-status-report:
    name: Report Deployment Status
    runs-on: ubuntu-latest
    needs: [post-apply-readiness, smoke-tests]
    if: always()

    steps:
      - name: Report Success
        if: needs.post-apply-readiness.result == 'success' && needs.smoke-tests.result == 'success'
        run: |
          echo "âœ… **Deployment Successful!**"
          echo "- Resources ready âœ“"
          echo "- E2E tests passed âœ“"

      - name: Report Failure
        if: failure()
        run: |
          echo "âŒ **Deployment Failed**"
          echo "[View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          exit 1

  test-report:
    name: Detailed Test Report
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Install dependencies
        working-directory: e2e_regressions
        run: uv sync

      - name: Generate test report
        working-directory: e2e_regressions
        run: uv run pytest -m smoke --html=report.html --self-contained-html || true

      - name: Upload test report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-report
          path: e2e_regressions/report.html
          retention-days: 30
