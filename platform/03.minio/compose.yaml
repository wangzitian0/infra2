services:
  vault-agent:
    image: hashicorp/vault:1.15
    container_name: platform-minio-vault-agent${ENV_SUFFIX}
    restart: always
    entrypoint:
      - sh
      - -c
      - |
        echo "$$VAULT_APP_TOKEN" > /vault/token
        exec vault agent -config=/etc/vault/vault-agent.hcl
    environment:
      VAULT_ADDR: ${VAULT_ADDR}
      VAULT_APP_TOKEN: ${VAULT_APP_TOKEN:-}
      ENV: ${ENV}
    volumes:
      - ./vault-agent.hcl:/etc/vault/vault-agent.hcl:ro
      - ./secrets.ctmpl:/etc/vault/secrets.ctmpl:ro
      - secrets:/vault/secrets
    networks:
      - dokploy-network

    healthcheck:
      test: ["CMD", "test", "-f", "/vault/secrets/.env"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  minio:
    # After RELEASE.2025-04-22T22-12-26Z, MinIO removed most of the admin UI
    # Using the last version with full Console admin features
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: platform-minio${ENV_SUFFIX}
    restart: always
    depends_on:
      - vault-agent
    environment:
      # Clear _FILE vars from base image to use env vars from /secrets/.env
      MINIO_ROOT_USER_FILE: ""
      MINIO_ROOT_PASSWORD_FILE: ""
      MINIO_ACCESS_KEY_FILE: ""
      MINIO_SECRET_KEY_FILE: ""
    entrypoint:
      - sh
      - -c
      - |
        # Wait for secrets file to be rendered by vault-agent
        while [ ! -f /secrets/.env ]; do
          echo "Waiting for secrets..."
          sleep 1
        done
        set -a
        . /secrets/.env
        set +a
        exec minio server /data --console-address ":9001"
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      start_period: 30s
      interval: 30s
      retries: 5
      timeout: 5s
    volumes:
      - secrets:/secrets:ro
      - ${DATA_PATH}:/data
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"

volumes:
  secrets:
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=10m,mode=0755"

networks:
  dokploy-network:
    external: true
