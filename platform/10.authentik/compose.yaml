services:
  vault-init:
    image: hashicorp/vault:1.15
    container_name: platform-authentik-vault-init
    command:
      - sh
      - -c
      - |
        apk add --no-cache jq
        export VAULT_TOKEN=$$VAULT_APP_TOKEN
        vault read -format=json secret/data/platform/production/postgres | \
          jq -r '.data.data | to_entries[] | select(.key == "root_password") | "PG_PASS=\(.value)"' > /secrets/.env

        vault read -format=json secret/data/platform/production/redis | \
          jq -r '.data.data | to_entries[] | select(.key == "password") | "REDIS_PASSWORD=\(.value)"' >> /secrets/.env
          
        vault read -format=json secret/data/platform/production/authentik | \
          jq -r '.data.data | to_entries[] | select(.key == "secret_key") | "AUTHENTIK_SECRET_KEY=\(.value)"' >> /secrets/.env
          
        chmod 444 /secrets/.env && echo "âœ… Secrets ready"
    environment:
      VAULT_ADDR: ${VAULT_ADDR}
      VAULT_APP_TOKEN: ${VAULT_APP_TOKEN:-}
    volumes:
      - secrets:/secrets
    networks:
      - dokploy-network
    restart: "no"

  server:
    image: ghcr.io/goauthentik/server:2024.12.0
    container_name: platform-authentik-server
    restart: unless-stopped
    command: server
    depends_on:
      vault-init:
        condition: service_completed_successfully
    env_file:
      - /secrets/.env
    environment:
      AUTHENTIK_REDIS__HOST: platform-redis
      AUTHENTIK_POSTGRESQL__HOST: platform-postgres
      AUTHENTIK_POSTGRESQL__USER: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
    volumes:
      - secrets:/secrets:ro
      - /data/platform/authentik/media:/media
      - /data/platform/authentik/certs:/certs
      - /data/platform/authentik/custom-templates:/templates
    networks:
      - dokploy-network
    healthcheck:
      test: [ "CMD", "ak", "healthcheck" ]
      interval: 30s
      timeout: 5s
      retries: 3

  worker:
    image: ghcr.io/goauthentik/server:2024.12.0
    container_name: platform-authentik-worker
    restart: unless-stopped
    command: worker
    depends_on:
      vault-init:
        condition: service_completed_successfully
    env_file:
      - /secrets/.env
    environment:
      AUTHENTIK_REDIS__HOST: platform-redis
      AUTHENTIK_POSTGRESQL__HOST: platform-postgres
      AUTHENTIK_POSTGRESQL__USER: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
    volumes:
      - secrets:/secrets:ro
      - /data/platform/authentik/media:/media
      - /data/platform/authentik/certs:/certs
      - /data/platform/authentik/custom-templates:/templates
    networks:
      - dokploy-network

volumes:
  secrets:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=10m,mode=0755"

networks:
  dokploy-network:
    external: true
