services:
  init-clickhouse:
    image: clickhouse/clickhouse-server:25.5.6
    container_name: platform-clickhouse-init${ENV_SUFFIX}
    restart: on-failure
    command:
      - bash
      - -c
      - |
        version="v0.0.1"
        node_os=$$(uname -s | tr '[:upper:]' '[:lower:]')
        node_arch=$$(uname -m | sed s/aarch64/arm64/ | sed s/x86_64/amd64/)
        echo "Fetching histogram-binary for $${node_os}/$${node_arch}"
        wget -q -O /tmp/histogram-quantile.tar.gz "https://github.com/SigNoz/signoz/releases/download/histogram-quantile%2F$${version}/histogram-quantile_$${node_os}_$${node_arch}.tar.gz"
        tar -xzf /tmp/histogram-quantile.tar.gz -C /tmp
        mkdir -p /var/lib/clickhouse/user_scripts
        mv /tmp/histogram-quantile /var/lib/clickhouse/user_scripts/histogramQuantile
        chmod +x /var/lib/clickhouse/user_scripts/histogramQuantile
        echo "Histogram binary installed successfully"
    volumes:
      - ${DATA_PATH}/user_scripts:/var/lib/clickhouse/user_scripts
    networks:
      - dokploy-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  zookeeper:
    image: zookeeper:3.9
    container_name: platform-clickhouse-zookeeper${ENV_SUFFIX}
    restart: unless-stopped
    environment:
      - ZOO_MY_ID=1
      # Single-node ZooKeeper. For multi-node, override ZOO_SERVERS to list all nodes.
      - ZOO_SERVERS=server.1=platform-clickhouse-zookeeper${ENV_SUFFIX}:2888:3888;2181
    volumes:
      - ${DATA_PATH}/zookeeper:/data
    networks:
      - dokploy-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD-SHELL", "echo stat | nc localhost 2181 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  clickhouse:
    image: clickhouse/clickhouse-server:25.5.6
    container_name: platform-clickhouse${ENV_SUFFIX}
    restart: unless-stopped
    depends_on:
      init-clickhouse:
        condition: service_completed_successfully
      zookeeper:
        condition: service_healthy
    environment:
      - CLICKHOUSE_DB=signoz
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - ${DATA_PATH}/data:/var/lib/clickhouse
      - ${DATA_PATH}/logs:/var/log/clickhouse-server
      - ${DATA_PATH}/user_scripts:/var/lib/clickhouse/user_scripts:ro
      # Config is rendered into DATA_PATH so it persists across redeploys.
      - ${DATA_PATH}/config.xml:/etc/clickhouse-server/config.xml:ro
      - ./users.xml:/etc/clickhouse-server/users.xml:ro
    networks:
      - dokploy-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    ulimits:
      nproc: 65535
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=false"

networks:
  dokploy-network:
    external: true
