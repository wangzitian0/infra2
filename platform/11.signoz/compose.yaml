services:
  schema-migrator:
    image: signoz/signoz-schema-migrator:v0.129.12
    container_name: platform-signoz-schema-migrator
    restart: "no"
    command: ["sync", "--dsn", "tcp://default@platform-clickhouse:9000"]
    networks:
      - dokploy-network

  signoz:
    image: signoz/signoz:v0.105.1
    container_name: platform-signoz
    hostname: signoz
    restart: unless-stopped
    depends_on:
      schema-migrator:
        condition: service_completed_successfully
    command:
      - --config=/root/config/prometheus.yml
    environment:
      - SIGNOZ_ALERTMANAGER_PROVIDER=signoz
      - SIGNOZ_TELEMETRYSTORE_CLICKHOUSE_DSN=tcp://default@platform-clickhouse:9000
      - SIGNOZ_SQLSTORE_SQLITE_PATH=/var/lib/signoz/signoz.db
      # JWT secret for authentication. Set via .env file or environment variable.
      - SIGNOZ_TOKENIZER_JWT_SECRET=${SIGNOZ_JWT_SECRET:-changeme_signoz_jwt_secret}
      - SIGNOZ_WEB_SELFREGISTRATION_ENABLED=true
      - STORAGE=clickhouse
      - GODEBUG=netdns=go
      - TELEMETRY_ENABLED=true
      - DEPLOYMENT_TYPE=docker-standalone
      - DOT_METRICS_ENABLED=true
    volumes:
      - ./prometheus.yml:/root/config/prometheus.yml:ro
      - /data/platform/signoz/data:/var/lib/signoz
    networks:
      dokploy-network:
        aliases:
          - signoz
          - signoz-query-service
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q localhost:8080/api/v1/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.signoz.rule=Host(`signoz.${INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.signoz.entrypoints=websecure"
      - "traefik.http.routers.signoz.tls.certresolver=letsencrypt"
      - "traefik.http.services.signoz.loadbalancer.server.port=8080"

  otel-collector:
    image: signoz/signoz-otel-collector:v0.129.12
    container_name: platform-signoz-otel-collector
    restart: unless-stopped
    depends_on:
      signoz:
        condition: service_healthy
    command:
      - --config=/etc/otel-collector-config.yaml
      - --feature-gates=-pkg.translator.prometheus.NormalizeName
    environment:
      - OTEL_RESOURCE_ATTRIBUTES=host.name=signoz-collector,os.type=linux
      - LOW_CARDINAL_EXCEPTION_GROUPING=false
      - SIGNOZ_COMPONENT=otel-collector
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    expose:
      - "4317"
      - "4318"
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/13133' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=false"

networks:
  dokploy-network:
    external: true
