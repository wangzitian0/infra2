# æ¥å…¥ SSO ç™»å½•

> **åœºæ™¯**ï¼šåº”ç”¨éœ€è¦ç”¨æˆ·èº«ä»½è®¤è¯åŠŸèƒ½
> **é¢„è®¡æ—¶é—´**ï¼š30 åˆ†é’Ÿ
> **å‰ç½®æ¡ä»¶**ï¼šå·²å®Œæˆ[éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨](./02.first-app.md)

---

## æ¦‚è¿°

å¹³å°æä¾› **Casdoor** ä½œä¸ºç»Ÿä¸€ SSO æœåŠ¡ï¼š

- **è®¿é—®åœ°å€**ï¼š`https://sso.${INTERNAL_DOMAIN}`
- **æ”¯æŒç™»å½•æ–¹å¼**ï¼šGitHub OAuth + å¯†ç ç™»å½•
- **åè®®**ï¼šOIDC (OpenID Connect)

**ä½ çš„åº”ç”¨å¯ä»¥**ï¼š
- ä½¿ç”¨ GitHub è´¦å·ç™»å½•
- ä½¿ç”¨å¹³å°å†…éƒ¨è´¦å·ï¼ˆç”¨æˆ·å+å¯†ç ï¼‰
- è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆemailã€å¤´åƒç­‰ï¼‰
- å®ç°æƒé™æ§åˆ¶

---

## å†³ç­–æ ‘ï¼šæˆ‘çš„åº”ç”¨éœ€è¦ SSO å—ï¼Ÿ

```mermaid
graph TD
    A[åº”ç”¨éœ€è¦ç”¨æˆ·ç™»å½•?] -->|æ˜¯| B{åº”ç”¨æ¡†æ¶æ”¯æŒ OIDC?}
    A -->|å¦| Z[ä¸éœ€è¦ SSO]

    B -->|æ˜¯| C[ä½¿ç”¨åŸç”Ÿ OIDC]
    B -->|å¦| D[ä½¿ç”¨ Portal Gate]

    C --> E[é˜…è¯»: åŸç”Ÿ OIDC æ¥å…¥]
    D --> F[è”ç³»è¿ç»´é…ç½® Portal Gate]
```

**æ¨è**ï¼šå¦‚æœä½ çš„æ¡†æ¶æ”¯æŒ OIDCï¼ˆå¤§éƒ¨åˆ†ç°ä»£æ¡†æ¶éƒ½æ”¯æŒï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨åŸç”Ÿ OIDCã€‚

---

## å¸¸è§æ¡†æ¶ OIDC æ”¯æŒæƒ…å†µ

| æ¡†æ¶/è¯­è¨€ | OIDC æ”¯æŒ | æ¨èåº“ |
|----------|----------|--------|
| **Next.js** | âœ… | `next-auth` |
| **Express.js** | âœ… | `passport-openidconnect` |
| **Django** | âœ… | `mozilla-django-oidc` |
| **FastAPI** | âœ… | `authlib` |
| **Spring Boot** | âœ… | Spring Security OAuth2 |
| **Laravel** | âœ… | `laravel/socialite` |
| **Go** | âœ… | `coreos/go-oidc` |

**å¦‚æœä½ çš„æ¡†æ¶ä¸åœ¨åˆ—è¡¨**ï¼šæœç´¢ "{framework} OIDC" æˆ–è”ç³»è¿ç»´å’¨è¯¢ã€‚

---

## åŸç”Ÿ OIDC æ¥å…¥ï¼ˆæ¨èï¼‰

### æ­¥éª¤ 1: åœ¨ Casdoor åˆ›å»ºåº”ç”¨

#### æ–¹å¼ 1: è”ç³»è¿ç»´åˆ›å»ºï¼ˆæ¨èï¼‰

æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
- **åº”ç”¨åç§°**ï¼š`my-app`
- **Redirect URI**ï¼š`https://my-app.truealpha.club/auth/callback`
  - æ³¨æ„ï¼šå¿…é¡»æ˜¯ä½ çš„åº”ç”¨åŸŸå + å›è°ƒè·¯å¾„
  - å¦‚æœæœ‰å¤šä¸ªç¯å¢ƒï¼Œæä¾›æ‰€æœ‰ URIsï¼ˆå¦‚ staging å’Œ prodï¼‰

è¿ç»´ä¼šé€šè¿‡ Terraform åˆ›å»ºåº”ç”¨ï¼Œå¹¶æä¾›ï¼š
- Client ID
- Client Secret

#### æ–¹å¼ 2: è‡ªå·±åœ¨ Casdoor UI åˆ›å»ºï¼ˆå¦‚æœæœ‰æƒé™ï¼‰

1. è®¿é—® `https://sso.${INTERNAL_DOMAIN}`
2. ä½¿ç”¨ admin è´¦å·ç™»å½•
3. å¯¼èˆªåˆ° "Applications"
4. ç‚¹å‡» "Add"
5. å¡«å†™ä¿¡æ¯ï¼š
   - Name: `my-app`
   - Organization: `admin`
   - Redirect URIs: `https://my-app.truealpha.club/auth/callback`
   - Enable Password: âœ…
   - Enable GitHub: âœ…
6. ä¿å­˜åè®°å½• Client ID å’Œ Client Secret

### æ­¥éª¤ 2: å°† Client Secret å­˜å…¥ Vault

è”ç³»è¿ç»´å°† Client Secret å­˜å…¥ Vaultï¼š

```
secret/data/my-app/casdoor
```

å†…å®¹ï¼š
```json
{
  "client_id": "my-app",
  "client_secret": "xxxxxx",
  "issuer": "https://sso.${INTERNAL_DOMAIN}"
}
```

### æ­¥éª¤ 3: åœ¨åº”ç”¨ä¸­é›†æˆ OIDC

#### Next.js ç¤ºä¾‹ (next-auth)

**å®‰è£…ä¾èµ–**ï¼š
```bash
npm install next-auth
```

**é…ç½® `pages/api/auth/[...nextauth].ts`**ï¼š

```typescript
import NextAuth from "next-auth";

export default NextAuth({
  providers: [
    {
      id: "casdoor",
      name: "Casdoor",
      type: "oauth",
      wellKnown: `${process.env.CASDOOR_ISSUER}/.well-known/openid-configuration`,
      authorization: { params: { scope: "openid profile email" } },
      clientId: process.env.CASDOOR_CLIENT_ID,
      clientSecret: process.env.CASDOOR_CLIENT_SECRET,
      profile(profile) {
        return {
          id: profile.sub,
          name: profile.name,
          email: profile.email,
          image: profile.avatar,
        };
      },
    },
  ],
  callbacks: {
    async jwt({ token, account, profile }) {
      if (account) {
        token.accessToken = account.access_token;
      }
      return token;
    },
    async session({ session, token }) {
      session.accessToken = token.accessToken;
      return session;
    },
  },
});
```

**ç¯å¢ƒå˜é‡**ï¼ˆé€šè¿‡ Vault æ³¨å…¥ï¼‰ï¼š
```bash
CASDOOR_CLIENT_ID=my-app
CASDOOR_CLIENT_SECRET=xxxxxx
CASDOOR_ISSUER=https://sso.${INTERNAL_DOMAIN}
NEXTAUTH_URL=https://my-app.truealpha.club
NEXTAUTH_SECRET=your-secret-key
```

**Vault Annotations**ï¼š
```yaml
vault.hashicorp.com/agent-inject-secret-casdoor: "secret/data/my-app/casdoor"
vault.hashicorp.com/agent-inject-template-casdoor: |
  {{- with secret "secret/data/my-app/casdoor" -}}
  export CASDOOR_CLIENT_ID="{{ .Data.data.client_id }}"
  export CASDOOR_CLIENT_SECRET="{{ .Data.data.client_secret }}"
  export CASDOOR_ISSUER="{{ .Data.data.issuer }}"
  {{- end }}
```

#### Express.js ç¤ºä¾‹ (passport)

**å®‰è£…ä¾èµ–**ï¼š
```bash
npm install passport passport-openidconnect express-session
```

**é…ç½®**ï¼š

```javascript
const passport = require('passport');
const { Strategy: OIDCStrategy } = require('passport-openidconnect');

passport.use('casdoor', new OIDCStrategy({
  issuer: process.env.CASDOOR_ISSUER,
  authorizationURL: `${process.env.CASDOOR_ISSUER}/login/oauth/authorize`,
  tokenURL: `${process.env.CASDOOR_ISSUER}/api/login/oauth/access_token`,
  userInfoURL: `${process.env.CASDOOR_ISSUER}/api/userinfo`,
  clientID: process.env.CASDOOR_CLIENT_ID,
  clientSecret: process.env.CASDOOR_CLIENT_SECRET,
  callbackURL: '/auth/callback',
  scope: 'openid profile email'
}, (issuer, profile, done) => {
  return done(null, profile);
}));

// Routes
app.get('/auth/login',
  passport.authenticate('casdoor'));

app.get('/auth/callback',
  passport.authenticate('casdoor', { failureRedirect: '/login' }),
  (req, res) => {
    res.redirect('/dashboard');
  });
```

#### Python (Django) ç¤ºä¾‹

**å®‰è£…ä¾èµ–**ï¼š
```bash
pip install mozilla-django-oidc
```

**settings.py**ï¼š

```python
INSTALLED_APPS = [
    ...
    'mozilla_django_oidc',
]

AUTHENTICATION_BACKENDS = [
    'mozilla_django_oidc.auth.OIDCAuthenticationBackend',
    'django.contrib.auth.backends.ModelBackend',
]

OIDC_RP_CLIENT_ID = os.environ['CASDOOR_CLIENT_ID']
OIDC_RP_CLIENT_SECRET = os.environ['CASDOOR_CLIENT_SECRET']
OIDC_OP_AUTHORIZATION_ENDPOINT = f"{os.environ['CASDOOR_ISSUER']}/login/oauth/authorize"
OIDC_OP_TOKEN_ENDPOINT = f"{os.environ['CASDOOR_ISSUER']}/api/login/oauth/access_token"
OIDC_OP_USER_ENDPOINT = f"{os.environ['CASDOOR_ISSUER']}/api/userinfo"

LOGIN_REDIRECT_URL = '/'
LOGOUT_REDIRECT_URL = '/'
```

### æ­¥éª¤ 4: æµ‹è¯•ç™»å½•æµç¨‹

1. è®¿é—®ä½ çš„åº”ç”¨ç™»å½•é¡µ
2. ç‚¹å‡»ç™»å½•æŒ‰é’®
3. åº”è¯¥è·³è½¬åˆ° Casdoor ç™»å½•é¡µï¼ˆ`https://sso.${INTERNAL_DOMAIN}`ï¼‰
4. é€‰æ‹© GitHub æˆ–å¯†ç ç™»å½•
5. æˆæƒåè·³è½¬å›åº”ç”¨
6. éªŒè¯è·å–åˆ°ç”¨æˆ·ä¿¡æ¯

---

## Portal Gate æ–¹å¼ï¼ˆæ—  OIDC æ¡†æ¶ï¼‰

å¦‚æœä½ çš„åº”ç”¨æ¡†æ¶ä¸æ”¯æŒ OIDCï¼Œå¯ä»¥ä½¿ç”¨ Portal Gateã€‚

### å·¥ä½œåŸç†

```mermaid
graph LR
    User[ç”¨æˆ·] -->|è®¿é—®| Traefik[Ingress]
    Traefik -->|æœªç™»å½•| OAuth2Proxy[OAuth2-Proxy]
    OAuth2Proxy -->|é‡å®šå‘| Casdoor[Casdoor ç™»å½•]
    Casdoor -->|ç™»å½•æˆåŠŸ| OAuth2Proxy
    OAuth2Proxy -->|è®¾ç½® Cookie + è½¬å‘è¯·æ±‚| App[åº”ç”¨]
    App -->|å“åº”| User
```

**ç‰¹ç‚¹**ï¼š
- åº”ç”¨æ— éœ€ä¿®æ”¹ä»£ç 
- ç”¨æˆ·ä¿¡æ¯é€šè¿‡ HTTP Headers ä¼ é€’ï¼š
  - `X-Auth-Request-User`: ç”¨æˆ·å
  - `X-Auth-Request-Email`: é‚®ç®±

### é…ç½®æ­¥éª¤

**è”ç³»è¿ç»´**å¯ç”¨ Portal Gateï¼š

æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
- åº”ç”¨åŸŸåï¼š`https://my-app.truealpha.club`
- éœ€è¦ä¿æŠ¤çš„è·¯å¾„ï¼š`/`ï¼ˆå…¨ç«™ï¼‰æˆ– `/admin`ï¼ˆéƒ¨åˆ†ï¼‰

è¿ç»´ä¼šåœ¨ Ingress æ·»åŠ  ForwardAuth é…ç½®ã€‚

### åœ¨åº”ç”¨ä¸­è·å–ç”¨æˆ·ä¿¡æ¯

**Node.js ç¤ºä¾‹**ï¼š

```javascript
app.get('/profile', (req, res) => {
  const username = req.headers['x-auth-request-user'];
  const email = req.headers['x-auth-request-email'];

  res.json({
    username,
    email,
  });
});
```

**æ³¨æ„**ï¼šPortal Gate åªæä¾›åŸºæœ¬ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚éœ€æ›´å¤šä¿¡æ¯éœ€è¦è°ƒç”¨ Casdoor APIã€‚

---

## è·å–æ›´å¤šç”¨æˆ·ä¿¡æ¯

### ä½¿ç”¨ OIDC UserInfo Endpoint

```javascript
const axios = require('axios');

async function getUserInfo(accessToken) {
  const response = await axios.get(
    `${process.env.CASDOOR_ISSUER}/api/userinfo`,
    {
      headers: {
        Authorization: `Bearer ${accessToken}`
      }
    }
  );
  return response.data;
}
```

**UserInfo è¿”å›æ•°æ®**ï¼š
```json
{
  "sub": "user-id",
  "name": "Zhang San",
  "email": "zhangsan@example.com",
  "avatar": "https://avatars.githubusercontent.com/u/xxx",
  "preferred_username": "zhangsan"
}
```

---

## æƒé™æ§åˆ¶

### åœºæ™¯ï¼šä¸åŒç”¨æˆ·æœ‰ä¸åŒæƒé™

Casdoor æ”¯æŒè§’è‰²å’Œæƒé™ç®¡ç†ï¼Œä½†éœ€è¦é¢å¤–é…ç½®ã€‚

**ç®€å•æ–¹æ¡ˆ**ï¼šåœ¨åº”ç”¨å†…éƒ¨ç®¡ç†æƒé™

```javascript
const roles = {
  'admin@example.com': 'admin',
  'user@example.com': 'user',
};

function checkPermission(email, requiredRole) {
  const userRole = roles[email] || 'guest';
  return userRole === requiredRole;
}

app.get('/admin', (req, res) => {
  const email = req.user.email;
  if (!checkPermission(email, 'admin')) {
    return res.status(403).send('Forbidden');
  }
  res.send('Admin Dashboard');
});
```

**é«˜çº§æ–¹æ¡ˆ**ï¼šé›†æˆ Casdoor æƒé™ç³»ç»Ÿï¼ˆè”ç³»è¿ç»´é…ç½®ï¼‰ã€‚

---

## å¸¸è§é—®é¢˜

### Q: ç™»å½•åå‡ºç°é‡å®šå‘å¾ªç¯

**åŸå› **ï¼šRedirect URI é…ç½®é”™è¯¯ã€‚

**è§£å†³**ï¼š
1. æ£€æŸ¥ Casdoor åº”ç”¨é…ç½®çš„ Redirect URI æ˜¯å¦å®Œå…¨åŒ¹é…
2. ç¡®è®¤åº”ç”¨ä»£ç ä¸­çš„ `callbackURL` è·¯å¾„æ­£ç¡®
3. æ£€æŸ¥åŸŸååè®®ï¼ˆhttps vs httpï¼‰

### Q: æç¤º "invalid_client"

**åŸå› **ï¼šClient ID æˆ– Client Secret é”™è¯¯ã€‚

**è§£å†³**ï¼š
1. ç¡®è®¤ Vault ä¸­çš„ secret æ­£ç¡®
2. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®æ³¨å…¥
3. é‡æ–°éƒ¨ç½²åº”ç”¨

### Q: è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥

**åŸå› **ï¼šAccess Token æ— æ•ˆæˆ–è¿‡æœŸã€‚

**è§£å†³**ï¼š
1. æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®ä¼ é€’
2. ç¡®è®¤ Scope åŒ…å« `openid profile email`
3. å®ç° Token åˆ·æ–°æœºåˆ¶

### Q: å¦‚ä½•å®ç°ç™»å‡ºï¼Ÿ

**Next.js**ï¼š
```javascript
import { signOut } from "next-auth/react";
await signOut({ callbackUrl: "/" });
```

**Express.js**ï¼š
```javascript
app.get('/logout', (req, res) => {
  req.logout(() => {
    res.redirect('/');
  });
});
```

---

## å¤šç¯å¢ƒé…ç½®

### Staging å’Œ Prod ä½¿ç”¨ä¸åŒçš„ Redirect URI

åœ¨ Casdoor åº”ç”¨é…ç½®ä¸­æ·»åŠ æ‰€æœ‰ç¯å¢ƒçš„ Redirect URIsï¼š

```
https://my-app-staging.truealpha.club/auth/callback
https://my-app.truealpha.club/auth/callback
```

åº”ç”¨ä»£ç ä½¿ç”¨ç¯å¢ƒå˜é‡åŠ¨æ€è®¾ç½®ï¼š

```javascript
const callbackURL = process.env.NODE_ENV === 'production'
  ? 'https://my-app.truealpha.club/auth/callback'
  : 'https://my-app-staging.truealpha.club/auth/callback';
```

æˆ–é€šè¿‡ Kubero ç¯å¢ƒå˜é‡è®¾ç½®ï¼š

```
CALLBACK_URL=https://my-app-staging.truealpha.club/auth/callback
```

---

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ çš„åº”ç”¨æ”¯æŒ SSO ç™»å½•äº†ï¼ğŸ‰

æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œç»§ç»­æ¢ç´¢ï¼š

| éœ€æ±‚ | ä¸‹ä¸€æ­¥é˜…è¯» |
|------|----------|
| **éœ€è¦ç›‘æ§å’Œæ—¥å¿—** | [ç›‘æ§å’Œåˆ†æ](./06.observability.md) |
| **éœ€è¦ç®¡ç†æ›´å¤šå¯†é’¥** | [ç®¡ç†å¯†é’¥](./04.secrets.md) |

---

## å‚è€ƒ

- **è®¤è¯æ¶æ„è¯¦è§£** - [platform.auth.md](../ssot/platform.auth.md)
- **Casdoor å®˜æ–¹æ–‡æ¡£** - https://casdoor.org/docs/overview
- **OIDC åè®®è¯´æ˜** - https://openid.net/connect/

---

*Last updated: 2025-12-21*
