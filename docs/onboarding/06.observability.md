# ç›‘æ§å’Œåˆ†æ

> **åœºæ™¯**ï¼šä¸ºåº”ç”¨æ·»åŠ ç›‘æ§ã€æ—¥å¿—è¿½è¸ªå’Œç”¨æˆ·è¡Œä¸ºåˆ†æ
> **é¢„è®¡æ—¶é—´**ï¼š40 åˆ†é’Ÿ
> **å‰ç½®æ¡ä»¶**ï¼šå·²å®Œæˆ[éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨](./02.first-app.md)

---

## æ¦‚è¿°

å¹³å°æä¾›ä¸¤ä¸ªå…³é”®å·¥å…·ï¼š

### SigNoz - åº”ç”¨æ€§èƒ½ç›‘æ§ (APM)
- **åŠŸèƒ½**ï¼šåˆ†å¸ƒå¼è¿½è¸ª + æ—¥å¿— + æŒ‡æ ‡
- **åè®®**ï¼šOpenTelemetry
- **è®¿é—®åœ°å€**ï¼š`https://signoz.${INTERNAL_DOMAIN}`ï¼ˆå¾…éƒ¨ç½²ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼š
  - è¿½è¸ª HTTP è¯·æ±‚æ€§èƒ½
  - ç›‘æ§æ•°æ®åº“æŸ¥è¯¢
  - å®šä½é”™è¯¯å’Œå¼‚å¸¸
  - æŸ¥çœ‹åº”ç”¨æ—¥å¿—

### OpenPanel - ç”¨æˆ·è¡Œä¸ºåˆ†æ
- **åŠŸèƒ½**ï¼šäº‹ä»¶è¿½è¸ª + A/B æµ‹è¯• + å®æ—¶ä»ªè¡¨æ¿
- **è®¿é—®åœ°å€**ï¼š`https://openpanel.${INTERNAL_DOMAIN}`ï¼ˆå¾…éƒ¨ç½²ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼š
  - è¿½è¸ªç”¨æˆ·è¡Œä¸ºï¼ˆç‚¹å‡»ã€é¡µé¢æµè§ˆï¼‰
  - åˆ†æè½¬åŒ–æ¼æ–—
  - ç”¨æˆ·ç•™å­˜åˆ†æ
  - éšç§ä¼˜å…ˆï¼ˆæ—  Cookie è¿½è¸ªï¼‰

**é‡è¦æç¤º**ï¼šSigNoz å’Œ OpenPanel åŸºç¡€è®¾æ–½å°šæœªéƒ¨ç½²ï¼Œæœ¬æ–‡æ¡£æä¾›æ¥å…¥å‡†å¤‡å’Œä»£ç ç¤ºä¾‹ï¼Œå¾…å¹³å°å°±ç»ªåå¯ç«‹å³ä½¿ç”¨ã€‚

---

## SigNoz: åº”ç”¨æ€§èƒ½ç›‘æ§

### ä»€ä¹ˆåº”è¯¥ç›‘æ§ï¼Ÿ

| æŒ‡æ ‡ç±»å‹ | ç¤ºä¾‹ | é‡è¦æ€§ |
|---------|------|--------|
| **HTTP è¯·æ±‚** | å»¶è¿Ÿ (P50/P95/P99)ã€é”™è¯¯ç‡ | ğŸ”´ å¿…é¡» |
| **æ•°æ®åº“æŸ¥è¯¢** | æŸ¥è¯¢æ—¶é—´ã€è¿æ¥æ± çŠ¶æ€ | ğŸ”´ å¿…é¡» |
| **å¤–éƒ¨ API è°ƒç”¨** | ç¬¬ä¸‰æ–¹æœåŠ¡å“åº”æ—¶é—´ | ğŸŸ¡ æ¨è |
| **ä¸šåŠ¡æŒ‡æ ‡** | è®¢å•æ•°ã€ç”¨æˆ·æ³¨å†Œæ•° | ğŸŸ¢ å¯é€‰ |

### æ­¥éª¤ 1: å®‰è£… OpenTelemetry SDK

#### Node.js

**è‡ªåŠ¨ Instrumentationï¼ˆæ¨èï¼‰**ï¼š

```bash
npm install --save \
  @opentelemetry/sdk-node \
  @opentelemetry/auto-instrumentations-node \
  @opentelemetry/exporter-trace-otlp-grpc
```

**åˆ›å»º `tracing.js`**ï¼š

```javascript
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-grpc');

const sdk = new NodeSDK({
  serviceName: process.env.OTEL_SERVICE_NAME || 'my-app',
  traceExporter: new OTLPTraceExporter({
    url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || 'grpc://otel-collector.observability.svc:4317',
  }),
  instrumentations: [getNodeAutoInstrumentations()],
});

sdk.start();

process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

**åœ¨åº”ç”¨å¯åŠ¨å‰å¼•å…¥**ï¼š

```javascript
// server.js
require('./tracing'); // å¿…é¡»åœ¨æœ€å‰é¢
const express = require('express');
// ... rest of your app
```

æˆ–ä½¿ç”¨ `--require` å‚æ•°ï¼š

```bash
node --require ./tracing.js server.js
```

#### Python (FastAPI)

**å®‰è£…ä¾èµ–**ï¼š

```bash
pip install opentelemetry-distro \
  opentelemetry-exporter-otlp \
  opentelemetry-instrumentation-fastapi
```

**è‡ªåŠ¨ Instrumentation**ï¼š

```python
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor

# åˆå§‹åŒ–
provider = TracerProvider()
processor = BatchSpanProcessor(
    OTLPSpanExporter(endpoint="otel-collector.observability.svc:4317", insecure=True)
)
provider.add_span_processor(processor)
trace.set_tracer_provider(provider)

# åœ¨ FastAPI app åˆ›å»ºå
from fastapi import FastAPI
app = FastAPI()

FastAPIInstrumentor.instrument_app(app)
```

#### Go

**å®‰è£…ä¾èµ–**ï¼š

```bash
go get go.opentelemetry.io/otel
go get go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc
go get go.opentelemetry.io/otel/sdk/trace
```

**åˆå§‹åŒ–**ï¼š

```go
import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/trace"
)

func initTracer() *trace.TracerProvider {
    exporter, _ := otlptracegrpc.New(
        context.Background(),
        otlptracegrpc.WithEndpoint("otel-collector.observability.svc:4317"),
        otlptracegrpc.WithInsecure(),
    )

    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
    )
    otel.SetTracerProvider(tp)
    return tp
}
```

### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Kubero æˆ– Deployment ä¸­è®¾ç½®ï¼š

```bash
OTEL_SERVICE_NAME=my-app-staging
OTEL_EXPORTER_OTLP_ENDPOINT=grpc://otel-collector.observability.svc:4317
```

**æ³¨æ„**ï¼šService Name å»ºè®®æ ¼å¼ `{app}-{env}`ï¼Œå¦‚ `my-app-staging`ã€‚

### æ­¥éª¤ 3: éªŒè¯è¿½è¸ªæ•°æ®

1. **éƒ¨ç½²åº”ç”¨**
2. **è§¦å‘ä¸€äº›è¯·æ±‚**ï¼ˆè®¿é—®åº”ç”¨çš„å‡ ä¸ªé¡µé¢ï¼‰
3. **åœ¨ SigNoz UI æŸ¥çœ‹**ï¼š
   - æ‰“å¼€ `https://signoz.${INTERNAL_DOMAIN}`
   - å¯¼èˆªåˆ° "Traces"
   - åº”è¯¥çœ‹åˆ°ä½ çš„ service (`my-app-staging`)
   - ç‚¹å‡»æŸ¥çœ‹è¯¦ç»† trace

**æœŸæœ›çœ‹åˆ°**ï¼š
- HTTP è¯·æ±‚çš„å®Œæ•´è°ƒç”¨é“¾
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
- å„é˜¶æ®µçš„è€—æ—¶åˆ†è§£

### æ­¥éª¤ 4: æ·»åŠ è‡ªå®šä¹‰ Span

å¯¹äºå…³é”®ä¸šåŠ¡é€»è¾‘ï¼Œæ‰‹åŠ¨æ·»åŠ  spanï¼š

**Node.js**ï¼š

```javascript
const { trace } = require('@opentelemetry/api');

async function processOrder(orderId) {
  const tracer = trace.getTracer('my-app');
  const span = tracer.startSpan('processOrder');

  span.setAttribute('order.id', orderId);

  try {
    // ä¸šåŠ¡é€»è¾‘
    await validateOrder(orderId);
    await chargePayment(orderId);
    await fulfillOrder(orderId);

    span.setStatus({ code: 1 }); // OK
  } catch (error) {
    span.setStatus({ code: 2, message: error.message }); // ERROR
    span.recordException(error);
    throw error;
  } finally {
    span.end();
  }
}
```

**Python**ï¼š

```python
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

def process_order(order_id):
    with tracer.start_as_current_span("processOrder") as span:
        span.set_attribute("order.id", order_id)
        # ä¸šåŠ¡é€»è¾‘
        validate_order(order_id)
        charge_payment(order_id)
        fulfill_order(order_id)
```

### æ­¥éª¤ 5: å‘é€æ—¥å¿—åˆ° SigNozï¼ˆå¯é€‰ï¼‰

OpenTelemetry ä¹Ÿæ”¯æŒæ—¥å¿—æ”¶é›†ï¼š

**Node.js (winston)**ï¼š

```bash
npm install winston @opentelemetry/winston-transport
```

```javascript
const winston = require('winston');
const { WinstonTransportV3 } = require('@opentelemetry/winston-transport');

const logger = winston.createLogger({
  transports: [
    new winston.transports.Console(),
    new WinstonTransportV3(),
  ],
});

logger.info('Order processed', { orderId: '12345' });
```

---

## OpenPanel: ç”¨æˆ·è¡Œä¸ºåˆ†æ

> **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://openpanel.dev/docs
> **SDK å‚è€ƒ**ï¼šhttps://openpanel.dev/docs/sdks

### æ­¥éª¤ 1: è·å– Client ID & Secret

1. è®¿é—® `https://openpanel.${INTERNAL_DOMAIN}`
2. ç™»å½•åè¿›å…¥ Project Settings
3. å¤åˆ¶ "Client ID" å’Œ "Client Secret"
4. å°†å‡­è¯å­˜å…¥ Vaultï¼ˆå‚è€ƒ[ç®¡ç†å¯†é’¥](./04.secrets.md)ï¼‰

```
secret/data/my-app/openpanel
```

å†…å®¹ï¼š
```json
{
  "client_id": "your_client_id",
  "client_secret": "your_client_secret",
  "api_url": "https://openpanel.${INTERNAL_DOMAIN}"
}
```

### æ­¥éª¤ 2: å‰ç«¯é›†æˆ

**å®‰è£… SDK**ï¼š

```bash
npm install @openpanel/nextjs
# æˆ–
npm install @openpanel/react
```

**åˆå§‹åŒ–ï¼ˆNext.js / Reactï¼‰**ï¼š

```javascript
import { OpenPanelComponent } from '@openpanel/nextjs';

function App({ Component, pageProps }) {
  return (
    <>
      <OpenPanelComponent
        clientId={process.env.NEXT_PUBLIC_OPENPANEL_CLIENT_ID}
        url={process.env.NEXT_PUBLIC_OPENPANEL_URL || 'https://openpanel.${INTERNAL_DOMAIN}'}
      />
      <Component {...pageProps} />
    </>
  );
}
```

**è¿½è¸ªäº‹ä»¶**ï¼š

```javascript
import { useOpenPanel } from '@openpanel/nextjs';

function SignUpButton() {
  const op = useOpenPanel();

  const handleClick = () => {
    op.track('button_clicked', {
      button_name: 'Sign Up',
      page: 'landing',
    });
  };

  return <button onClick={handleClick}>Sign Up</button>;
}
```

### æ­¥éª¤ 3: åç«¯é›†æˆï¼ˆå¯é€‰ï¼‰

**Node.js**ï¼š

```bash
npm install @openpanel/sdk
```

```javascript
import { OpenPanel } from '@openpanel/sdk';

const op = new OpenPanel({
  clientId: process.env.OPENPANEL_CLIENT_ID,
  clientSecret: process.env.OPENPANEL_CLIENT_SECRET,
  apiUrl: process.env.OPENPANEL_URL || 'https://openpanel.${INTERNAL_DOMAIN}',
});

// è¿½è¸ªæœåŠ¡ç«¯äº‹ä»¶
await op.track({
  userId: 'user-123',
  event: 'order_completed',
  properties: {
    order_id: '12345',
    amount: 99.99,
  },
});
```

**Python**ï¼š

```bash
pip install openpanel
```

```python
from openpanel import OpenPanel

op = OpenPanel(
    client_id=os.environ['OPENPANEL_CLIENT_ID'],
    client_secret=os.environ['OPENPANEL_CLIENT_SECRET'],
    api_url=os.environ.get('OPENPANEL_URL', 'https://openpanel.${INTERNAL_DOMAIN}')
)

op.track(
    user_id='user-123',
    event='order_completed',
    properties={
        'order_id': '12345',
        'amount': 99.99
    }
)
```

### æ­¥éª¤ 4: åœ¨ OpenPanel UI æŸ¥çœ‹æ•°æ®

1. **Events** - æŸ¥çœ‹æ‰€æœ‰äº‹ä»¶æµ
2. **Funnels** - åˆ›å»ºè½¬åŒ–æ¼æ–—åˆ†æ
3. **Dashboards** - ç»„åˆå¤šä¸ªå›¾è¡¨
4. **Retention** - ç”¨æˆ·ç•™å­˜åˆ†æ

---

## ç›‘æ§æœ€ä½³å®è·µ

### 1. å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡

**HTTP è¯·æ±‚**ï¼š
```javascript
// è‡ªåŠ¨æ•è·ï¼ˆOpenTelemetry è‡ªåŠ¨ instrumentationï¼‰
// æ‰‹åŠ¨æŒ‡æ ‡ï¼š
span.setAttribute('http.status_code', 200);
span.setAttribute('http.method', 'GET');
span.setAttribute('http.route', '/api/users/:id');
```

**æ•°æ®åº“æŸ¥è¯¢**ï¼š
```javascript
// è‡ªåŠ¨æ•è·
// é‡ç‚¹å…³æ³¨æ…¢æŸ¥è¯¢ (> 1s)
```

**é”™è¯¯ç‡**ï¼š
```javascript
// åœ¨å¼‚å¸¸å¤„ç†ä¸­è®°å½•
span.recordException(error);
span.setStatus({ code: 2, message: error.message });
```

### 2. é‡‡æ ·ç­–ç•¥

**å¼€å‘ç¯å¢ƒ**ï¼š100% é‡‡æ ·ï¼ˆæµ‹è¯•ç”¨ï¼‰
```bash
OTEL_TRACES_SAMPLER=always_on
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼šæ ¹æ®æµé‡è°ƒæ•´
```bash
OTEL_TRACES_SAMPLER=traceidratio
OTEL_TRACES_SAMPLER_ARG=0.1  # 10% é‡‡æ ·
```

### 3. å‘Šè­¦é˜ˆå€¼å»ºè®®

åœ¨ SigNoz è®¾ç½®å‘Šè­¦ï¼š

| æŒ‡æ ‡ | é˜ˆå€¼ | çº§åˆ« |
|------|------|------|
| P95 å»¶è¿Ÿ | > 1s | è­¦å‘Š |
| P99 å»¶è¿Ÿ | > 3s | ç´§æ€¥ |
| é”™è¯¯ç‡ | > 1% | è­¦å‘Š |
| é”™è¯¯ç‡ | > 5% | ç´§æ€¥ |
| æ•°æ®åº“è¿æ¥æ±  | > 80% | è­¦å‘Š |

### 4. æ—¥å¿—çº§åˆ«è§„èŒƒ

```javascript
logger.error('Payment failed', { userId, orderId, error }); // éœ€è¦ç«‹å³å¤„ç†
logger.warn('Retry attempt', { attempt: 2 }); // å¼‚å¸¸ä½†å¯æ¢å¤
logger.info('Order created', { orderId }); // å…³é”®ä¸šåŠ¡äº‹ä»¶
logger.debug('Processing step 1'); // ä»…å¼€å‘ç¯å¢ƒ
```

**ç”Ÿäº§ç¯å¢ƒæ¨è**ï¼šINFO çº§åˆ«

---

## å¸¸è§åˆ†æåœºæ™¯

### åœºæ™¯ 1: ç”¨æˆ·æ³¨å†Œè½¬åŒ–æ¼æ–—

**OpenPanel Events**ï¼š
```javascript
import { useOpenPanel } from '@openpanel/nextjs';

// é¡µé¢è®¿é—®
op.track('page_view', { page: 'signup' });

// å¡«å†™è¡¨å•
op.track('signup_form_filled');

// æäº¤è¡¨å•
op.track('signup_submitted');

// éªŒè¯é‚®ç®±
op.track('email_verified');

// å®Œæˆæ³¨å†Œ
op.track('signup_completed');
```

**åœ¨ OpenPanel åˆ›å»º Funnel**ï¼š
1. Funnels â†’ Create New Funnel
2. æ·»åŠ æ­¥éª¤ï¼špage_view â†’ filled â†’ submitted â†’ verified â†’ completed
3. æŸ¥çœ‹å„æ­¥éª¤è½¬åŒ–ç‡

### åœºæ™¯ 2: åŠŸèƒ½ä½¿ç”¨æƒ…å†µ

```javascript
// A åŠŸèƒ½
op.track('feature_used', { feature: 'export_csv' });

// B åŠŸèƒ½
op.track('feature_used', { feature: 'import_data' });
```

**Dashboard**ï¼šæŒ‰ feature å±æ€§åˆ†ç»„ç»Ÿè®¡ä½¿ç”¨æ¬¡æ•°

### åœºæ™¯ 3: API æ€§èƒ½åˆ†æ

åœ¨ SigNoz ä¸­ï¼š
1. æŒ‰ API endpoint åˆ†ç»„
2. æŸ¥çœ‹ P50/P95/P99 å»¶è¿Ÿ
3. è¯†åˆ«æ…¢æ¥å£
4. Drill down åˆ°å…·ä½“ trace åˆ†æç“¶é¢ˆ

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: SigNoz çœ‹ä¸åˆ° traces

**æ’æŸ¥**ï¼š
1. ç¡®è®¤ OTEL_EXPORTER_OTLP_ENDPOINT é…ç½®æ­£ç¡®
2. æ£€æŸ¥åº”ç”¨æ—¥å¿—æ˜¯å¦æœ‰ OTLP é”™è¯¯
3. éªŒè¯ otel-collector æœåŠ¡è¿è¡Œï¼š
   ```bash
   kubectl get svc -n observability
   ```
4. æµ‹è¯•è¿æ¥ï¼š
   ```bash
   kubectl exec -it <pod> -n apps-staging -- \
     nc -zv otel-collector.observability.svc 4317
   ```

### é—®é¢˜ 2: OpenPanel äº‹ä»¶æœªæ”¶åˆ°

**æ’æŸ¥**ï¼š
1. ç¡®è®¤ Client ID å’Œ Client Secret æ­£ç¡®
2. æ£€æŸ¥æµè§ˆå™¨ Network é¢æ¿ï¼ŒæŸ¥çœ‹è¯·æ±‚æ˜¯å¦å‘é€åˆ° `/api/track`
3. ç¡®è®¤ OpenPanel URL é…ç½®æ­£ç¡®ï¼ˆ`https://openpanel.${INTERNAL_DOMAIN}`ï¼‰
4. åœ¨ OpenPanel UI æŸ¥çœ‹ Events é¡µé¢ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

### é—®é¢˜ 3: æ€§èƒ½å½±å“

**OpenTelemetry æ€§èƒ½å¼€é”€**ï¼šé€šå¸¸ < 5%

**å¦‚æœå½±å“æ˜æ˜¾**ï¼š
- é™ä½é‡‡æ ·ç‡ï¼ˆå¦‚ 10% â†’ 5%ï¼‰
- ç¦ç”¨æŸäº›è‡ªåŠ¨ instrumentation
- ä½¿ç”¨å¼‚æ­¥ exporter

---

## å½“å‰çŠ¶æ€å’Œå‡†å¤‡

### SigNoz å’Œ OpenPanel å°šæœªéƒ¨ç½²

**ä½ ç°åœ¨å¯ä»¥åšä»€ä¹ˆ**ï¼š
1. âœ… åœ¨åº”ç”¨ä¸­é›†æˆ OpenTelemetry SDKï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡æ§åˆ¶æ˜¯å¦å¯ç”¨ï¼‰
2. âœ… å‡†å¤‡å¥½ service name å’Œé‡‡æ ·ç­–ç•¥
3. âœ… è®¾è®¡è¦è¿½è¸ªçš„è‡ªå®šä¹‰äº‹ä»¶

**å¾…å¹³å°å°±ç»ªå**ï¼š
1. è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨ tracing
2. éƒ¨ç½²åº”ç”¨
3. åœ¨ SigNoz/OpenPanel UI éªŒè¯æ•°æ®

**è·å–é€šçŸ¥**ï¼š
- è®¢é˜…ç›¸å…³ Issueï¼ˆå¾…åˆ›å»ºï¼‰
- å…³æ³¨æ–‡æ¡£æ›´æ–°

---

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ äº†è§£äº†ç›‘æ§å’Œåˆ†æçš„å®Œæ•´æµç¨‹ï¼ğŸ‰

**å¤ä¹ æ ¸å¿ƒæµç¨‹**ï¼š
1. [éƒ¨ç½²åº”ç”¨](./02.first-app.md)
2. [è¿æ¥æ•°æ®åº“](./03.database.md)
3. [ç®¡ç†å¯†é’¥](./04.secrets.md)
4. [æ¥å…¥ SSO](./05.sso.md)
5. [ç›‘æ§å’Œåˆ†æ](./06.observability.md)ï¼ˆæœ¬æ–‡æ¡£ï¼‰

**æ¢ç´¢æ›´å¤š**ï¼š
- [SSOT æ–‡æ¡£ç´¢å¼•](../ssot/README.md)
- [å¹³å°æ¶æ„](https://github.com/wangzitian0/infra2/blob/main/platform/README.md)

---

## å‚è€ƒ

- **å¯è§‚æµ‹æ€§ SSOT** - [ops.observability.md](../ssot/ops.observability.md)
- **OpenTelemetry å®˜æ–¹æ–‡æ¡£** - https://opentelemetry.io/docs/
- **SigNoz æ–‡æ¡£** - https://signoz.io/docs/
- **OpenPanel æ–‡æ¡£** - https://openpanel.dev/docs

---

*Last updated: 2025-12-21*
