# éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨

> **åœºæ™¯**ï¼šå°†ä¸€ä¸ªç®€å•çš„ Web åº”ç”¨éƒ¨ç½²åˆ°å¹³å°ï¼Œæ— éœ€æ•°æ®åº“æˆ–å…¶ä»–ä¾èµ–
> **é¢„è®¡æ—¶é—´**ï¼š15 åˆ†é’Ÿ
> **å‰ç½®æ¡ä»¶**ï¼šGit ä»“åº“ + Dockerfile

---

## æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸¦ä½ å®Œæˆï¼š
1. âœ… è®¿é—® Kubero UI
2. âœ… åˆ›å»ºç¬¬ä¸€ä¸ª Pipeline
3. âœ… è¿æ¥ Git ä»“åº“
4. âœ… é…ç½®éƒ¨ç½²å‚æ•°
5. âœ… è§¦å‘éƒ¨ç½²
6. âœ… è®¿é—®åº”ç”¨

---

## æ­¥éª¤ 1: è®¿é—® Kubero UI

### 1.1 æ‰“å¼€ Kubero

è®¿é—® `https://kcloud.${INTERNAL_DOMAIN}`

### 1.2 ä½¿ç”¨ SSO ç™»å½•

é€‰æ‹©ç™»å½•æ–¹å¼ï¼š
- **GitHub** - ä½¿ç”¨ GitHub è´¦å·ç™»å½•
- **å¯†ç ç™»å½•** - ä½¿ç”¨å¹³å°åˆ†é…çš„è´¦å·

**é¦–æ¬¡ç™»å½•**ï¼šå¦‚æœä½ æ˜¯æ–°ç”¨æˆ·ï¼Œè”ç³»è¿ç»´å›¢é˜Ÿå¼€é€šæƒé™ã€‚

### 1.3 éªŒè¯ç™»å½•æˆåŠŸ

ç™»å½•ååº”è¯¥çœ‹åˆ° Kubero Dashboardï¼ŒåŒ…å«ï¼š
- å·¦ä¾§èœå•ï¼šPipelinesã€Settings
- ä¸»ç•Œé¢ï¼šPipeline åˆ—è¡¨ï¼ˆé¦–æ¬¡ç™»å½•ä¸ºç©ºï¼‰

---

## æ­¥éª¤ 2: å‡†å¤‡ç¤ºä¾‹åº”ç”¨

å¦‚æœä½ è¿˜æ²¡æœ‰åº”ç”¨ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ç¤ºä¾‹ï¼š

### ç¤ºä¾‹ï¼šNode.js Hello World

```bash
# å…‹éš†ç¤ºä¾‹ä»“åº“ï¼ˆå¾…åˆ›å»ºï¼‰
git clone https://github.com/wangzitian0/infra-demo-apps.git
cd infra-demo-apps/hello-world-node
```

**ç›®å½•ç»“æ„**ï¼š
```
hello-world-node/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ package.json
â”œâ”€â”€ server.js
â””â”€â”€ README.md
```

**Dockerfile ç¤ºä¾‹**ï¼š
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["node", "server.js"]
```

**server.js**ï¼š
```javascript
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.json({
    message: 'Hello from Kubero!',
    env: process.env.NODE_ENV || 'development'
  });
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## æ­¥éª¤ 3: åœ¨ Kubero åˆ›å»º Pipeline

### 3.1 ç‚¹å‡» "Create Pipeline"

åœ¨ Kubero ä¸»ç•Œé¢ç‚¹å‡» "New Pipeline" æŒ‰é’®ã€‚

### 3.2 å¡«å†™ Pipeline åŸºæœ¬ä¿¡æ¯

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| **Name** | `my-first-app` | Pipeline åç§°ï¼ˆå°å†™å­—æ¯+è¿å­—ç¬¦ï¼‰ |
| **Git Provider** | GitHub | ä»£ç æ‰˜ç®¡å¹³å° |
| **Repository** | `your-username/your-repo` | Git ä»“åº“åœ°å€ |
| **Branch** | `main` | éƒ¨ç½²åˆ†æ”¯ |

### 3.3 é…ç½® Git è¿æ¥

**æ–¹å¼ 1: OAuthï¼ˆæ¨èï¼‰**
- ç‚¹å‡» "Connect with GitHub"
- æˆæƒ Kubero è®¿é—®ä½ çš„ä»“åº“

**æ–¹å¼ 2: Deploy Key**
- Kubero ä¼šç”Ÿæˆ SSH Key
- å°†å…¬é’¥æ·»åŠ åˆ° GitHub repo çš„ Deploy Keys

---

## æ­¥éª¤ 4: é…ç½® Phaseï¼ˆç¯å¢ƒï¼‰

Kubero çš„ Pipeline å¯ä»¥åŒ…å«å¤šä¸ª Phaseï¼ˆç¯å¢ƒï¼‰ï¼Œæˆ‘ä»¬å…ˆé…ç½® Stagingã€‚

### 4.1 æ·»åŠ  Staging Phase

ç‚¹å‡» "Add Phase"ï¼Œå¡«å†™ï¼š

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| **Phase Name** | `staging` | ç¯å¢ƒåç§° |
| **Namespace** | `apps-staging` | Kubernetes namespace |
| **Subdomain** | `my-first-app-staging` | å­åŸŸåå‰ç¼€ |
| **Buildpack** | `Dockerfile` | ä½¿ç”¨ Dockerfile æ„å»º |

### 4.2 é…ç½®åŸŸå

å®Œæ•´åŸŸåå°†æ˜¯ï¼š`https://my-first-app-staging.truealpha.club`

ï¼ˆæ ¹æ®å¹³å°é…ç½®ï¼Œå¯èƒ½æ˜¯å…¶ä»–åŸŸåï¼‰

### 4.3 é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

å¦‚æœåº”ç”¨éœ€è¦ç¯å¢ƒå˜é‡ï¼Œåœ¨ "Environment Variables" æ·»åŠ ï¼š

| Key | Value | Secret |
|-----|-------|--------|
| `NODE_ENV` | `staging` | âŒ |
| `PORT` | `3000` | âŒ |

**æ³¨æ„**ï¼šæš‚æ—¶ä¸æ¶‰åŠ Vault å¯†é’¥ï¼Œè¿™éƒ¨åˆ†åœ¨[ä½¿ç”¨æ•°æ®åº“](./03.database.md)ä¸­è¯¦ç»†è¯´æ˜ã€‚

### 4.4 é…ç½®èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼‰

æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´ï¼š

| èµ„æº | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| **CPU Request** | `100m` | ä¿è¯çš„ CPU |
| **CPU Limit** | `500m` | æœ€å¤§ CPU |
| **Memory Request** | `128Mi` | ä¿è¯çš„å†…å­˜ |
| **Memory Limit** | `512Mi` | æœ€å¤§å†…å­˜ |

---

## æ­¥éª¤ 5: è§¦å‘éƒ¨ç½²

### 5.1 åˆ›å»º Pipeline

ç‚¹å‡» "Create" å®Œæˆ Pipeline åˆ›å»ºã€‚

### 5.2 è§¦å‘é¦–æ¬¡éƒ¨ç½²

Kubero ä¼šè‡ªåŠ¨ï¼š
1. æ‹‰å– Git ä»£ç 
2. ä½¿ç”¨ Dockerfile æ„å»ºé•œåƒ
3. æ¨é€åˆ°å†…éƒ¨é•œåƒä»“åº“
4. éƒ¨ç½²åˆ° Kubernetes

### 5.3 æŸ¥çœ‹æ„å»ºæ—¥å¿—

åœ¨ Pipeline è¯¦æƒ…é¡µé¢ï¼š
- ç‚¹å‡» "Builds" æŸ¥çœ‹æ„å»ºå†å²
- ç‚¹å‡»æœ€æ–°çš„ Build æŸ¥çœ‹å®æ—¶æ—¥å¿—

**æœŸæœ›è¾“å‡º**ï¼š
```
[INFO] Cloning repository...
[INFO] Building Docker image...
[INFO] Pushing image to registry...
[INFO] Deploying to apps-staging...
[SUCCESS] Deployment completed
```

---

## æ­¥éª¤ 6: éªŒè¯éƒ¨ç½²

### 6.1 æ£€æŸ¥ Pod çŠ¶æ€

åœ¨ Kubero UI çš„ "Pods" æ ‡ç­¾é¡µï¼Œåº”è¯¥çœ‹åˆ°ï¼š

| Pod Name | Status | Ready |
|----------|--------|-------|
| `my-first-app-staging-xxx` | Running | 1/1 |

### 6.2 è®¿é—®åº”ç”¨

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`https://my-first-app-staging.truealpha.club`

**æœŸæœ›å“åº”**ï¼š
```json
{
  "message": "Hello from Kubero!",
  "env": "staging"
}
```

### 6.3 æŸ¥çœ‹åº”ç”¨æ—¥å¿—

åœ¨ Kubero UI ç‚¹å‡» "Logs"ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
Server running on port 3000
```

---

## æ­¥éª¤ 7: è§¦å‘é‡æ–°éƒ¨ç½²

### æ–¹å¼ 1: æ¨é€ä»£ç è§¦å‘

ä¿®æ”¹ `server.js`ï¼Œæäº¤å¹¶æ¨é€ï¼š

```bash
git add .
git commit -m "Update message"
git push origin main
```

Kubero ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°å˜æ›´å¹¶é‡æ–°éƒ¨ç½²ã€‚

### æ–¹å¼ 2: æ‰‹åŠ¨è§¦å‘

åœ¨ Kubero UI ç‚¹å‡» "Redeploy" æŒ‰é’®ã€‚

---

## æ·»åŠ  Prod ç¯å¢ƒï¼ˆå¯é€‰ï¼‰

### 7.1 åœ¨åŒä¸€ä¸ª Pipeline æ·»åŠ  Prod Phase

ç‚¹å‡» "Add Phase"ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| **Phase Name** | `prod` |
| **Namespace** | `apps-prod` |
| **Subdomain** | `my-first-app` |

å®Œæ•´åŸŸåï¼š`https://my-first-app.truealpha.club`

### 7.2 Prod ç¯å¢ƒéƒ¨ç½²ç­–ç•¥

**å»ºè®®æµç¨‹**ï¼š
1. å…ˆåœ¨ Staging æµ‹è¯•éªŒè¯
2. ç¡®è®¤æ— è¯¯åï¼Œæ‰‹åŠ¨è§¦å‘ Prod éƒ¨ç½²
3. Prod ä½¿ç”¨ç‹¬ç«‹çš„ Git tag æˆ– release branch

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ„å»ºå¤±è´¥ - Dockerfile not found

**åŸå› **ï¼šKubero åœ¨ä»“åº“æ ¹ç›®å½•æ‰¾ä¸åˆ° Dockerfile

**è§£å†³**ï¼š
- ç¡®è®¤ Dockerfile åœ¨ä»“åº“æ ¹ç›®å½•
- æˆ–åœ¨ Buildpack é…ç½®ä¸­æŒ‡å®š Dockerfile è·¯å¾„

### é—®é¢˜ 2: Pod å¯åŠ¨å¤±è´¥ - CrashLoopBackOff

**åŸå› **ï¼šåº”ç”¨å¯åŠ¨å¤±è´¥æˆ–ç«‹å³é€€å‡º

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æŸ¥çœ‹ Pod æ—¥å¿—ï¼ˆKubero UI â†’ Logsï¼‰
2. æ£€æŸ¥åº”ç”¨ç›‘å¬çš„ç«¯å£æ˜¯å¦ä¸é…ç½®ä¸€è‡´
3. æ£€æŸ¥åº”ç”¨æ˜¯å¦æœ‰å¯åŠ¨é”™è¯¯

### é—®é¢˜ 3: æ— æ³•è®¿é—®åº”ç”¨ - 502 Bad Gateway

**åŸå› **ï¼šIngress é…ç½®é—®é¢˜æˆ–åº”ç”¨æœªæ­£å¸¸ç›‘å¬ç«¯å£

**æ’æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤ Pod çŠ¶æ€ä¸º Running
2. ç¡®è®¤åº”ç”¨ç›‘å¬åœ¨æ­£ç¡®çš„ç«¯å£ï¼ˆä¸ Service é…ç½®ä¸€è‡´ï¼‰
3. æ£€æŸ¥ Ingress é…ç½®ï¼ˆè”ç³»è¿ç»´ï¼‰

### é—®é¢˜ 4: åŸŸåæ— æ³•è§£æ

**åŸå› **ï¼šDNS æœªé…ç½®æˆ– Cloudflare proxy æœªç”Ÿæ•ˆ

**è§£å†³**ï¼š
- ç­‰å¾… DNS ä¼ æ’­ï¼ˆé€šå¸¸ 1-5 åˆ†é’Ÿï¼‰
- ä½¿ç”¨ `nslookup` éªŒè¯ DNS è®°å½•
- è”ç³»è¿ç»´æ£€æŸ¥ Cloudflare é…ç½®

---

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æˆåŠŸéƒ¨ç½²äº†ç¬¬ä¸€ä¸ªåº”ç”¨ï¼ğŸ‰

æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œç»§ç»­æ¢ç´¢ï¼š

| éœ€æ±‚ | ä¸‹ä¸€æ­¥é˜…è¯» |
|------|----------|
| **åº”ç”¨éœ€è¦ PostgreSQL** | [ä½¿ç”¨æ•°æ®åº“](./03.database.md) |
| **ç®¡ç† API Keys ç­‰å¯†é’¥** | [ç®¡ç†å¯†é’¥](./04.secrets.md) |
| **éœ€è¦ç”¨æˆ·ç™»å½•åŠŸèƒ½** | [æ¥å…¥ SSO](./05.sso.md) |
| **éœ€è¦ç›‘æ§å’Œæ—¥å¿—** | [ç›‘æ§å’Œåˆ†æ](./06.observability.md) |

---

## å‚è€ƒ

- **Kubero æ¶æ„è¯¦è§£** - [platform/README.md](../../platform/README.md)
- **åŸŸåå’Œç½‘ç»œé…ç½®** - [platform.network.md](../ssot/platform.network.md)
- **ç¯å¢ƒæ¨¡å‹è¯´æ˜** - [core.env.md](../ssot/core.env.md)

---

*Last updated: 2025-12-24*
