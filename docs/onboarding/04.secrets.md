# ç®¡ç†å¯†é’¥

> **åœºæ™¯**ï¼šåº”ç”¨éœ€è¦ç®¡ç† API Keysã€Tokensã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
> **é¢„è®¡æ—¶é—´**ï¼š20 åˆ†é’Ÿ
> **å‰ç½®æ¡ä»¶**ï¼šå·²å®Œæˆ[éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨](./02.first-app.md)

---

## æ¦‚è¿°

**ä¸ºä»€ä¹ˆéœ€è¦ Vaultï¼Ÿ**
- âœ… **é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰å¯†é’¥ç»Ÿä¸€å­˜å‚¨ï¼Œé¿å…æ•£è½åœ¨ä»£ç ã€é…ç½®æ–‡ä»¶
- âœ… **è®¿é—®æ§åˆ¶**ï¼šæ¯ä¸ªåº”ç”¨åªèƒ½è®¿é—®è‡ªå·±çš„å¯†é’¥
- âœ… **è‡ªåŠ¨æ³¨å…¥**ï¼šæ— éœ€æ‰‹åŠ¨é…ç½®ç¯å¢ƒå˜é‡
- âœ… **å®¡è®¡æ—¥å¿—**ï¼šè¿½è¸ªå¯†é’¥çš„è®¿é—®è®°å½•

**Vault è®¿é—®åœ°å€**ï¼š`https://secrets.${INTERNAL_DOMAIN}`

---

## å¸¸è§åœºæ™¯

### åœºæ™¯ 1: ç¬¬ä¸‰æ–¹ API Keys

åº”ç”¨éœ€è¦è°ƒç”¨å¤–éƒ¨ APIï¼ˆå¦‚ OpenAIã€Stripeã€SendGridï¼‰ã€‚

### åœºæ™¯ 2: åº”ç”¨é—´é€šä¿¡ Token

å¾®æœåŠ¡é—´éœ€è¦ä½¿ç”¨ JWT token æˆ– API key è¿›è¡Œè®¤è¯ã€‚

### åœºæ™¯ 3: åŠ å¯†å¯†é’¥

åº”ç”¨éœ€è¦åŠ å¯†/è§£å¯†æ•°æ®çš„å¯†é’¥ï¼ˆå¦‚ AES keyï¼‰ã€‚

---

## å¿«é€Ÿå¼€å§‹ï¼šæ·»åŠ ä¸€ä¸ª API Key

### æ­¥éª¤ 1: ç¡®å®šå¯†é’¥å­˜å‚¨è·¯å¾„

Vault ä½¿ç”¨è·¯å¾„ç»„ç»‡å¯†é’¥ï¼Œæ¨èæŒ‰åº”ç”¨åˆ’åˆ†ï¼š

```
secret/data/my-app/openai
secret/data/my-app/stripe
secret/data/my-app/jwt-secret
```

### æ­¥éª¤ 2: è”ç³»è¿ç»´æ·»åŠ å¯†é’¥åˆ° Vault

**æ–¹å¼ 1: é€šè¿‡è¿ç»´å›¢é˜Ÿ**ï¼ˆæ¨èï¼‰

æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
- åº”ç”¨åç§°ï¼š`my-app`
- å¯†é’¥è·¯å¾„ï¼š`secret/data/my-app/openai`
- å¯†é’¥å†…å®¹ï¼ˆé€šè¿‡å®‰å…¨æ¸ é“ä¼ é€’ï¼Œå¦‚ 1Passwordï¼‰

**æ–¹å¼ 2: è‡ªå·±é€šè¿‡ Vault UI æ·»åŠ **ï¼ˆå¦‚æœæœ‰æƒé™ï¼‰

1. è®¿é—® `https://secrets.${INTERNAL_DOMAIN}`
2. ä½¿ç”¨ SSO ç™»å½•
3. å¯¼èˆªåˆ° `secret/my-app/`
4. ç‚¹å‡» "Create secret"
5. æ·»åŠ  key-value pairsï¼š
   ```
   api_key: sk-xxxxxxxxxx
   organization_id: org-xxxxxxxxxx
   ```

### æ­¥éª¤ 3: é…ç½® Vault Roleï¼ˆä¸€æ¬¡æ€§ï¼‰

å¦‚æœè¿™æ˜¯ä½ çš„ç¬¬ä¸€ä¸ªå¯†é’¥ï¼Œéœ€è¦è”ç³»è¿ç»´åˆ›å»º Vault Roleï¼ˆå‚è€ƒ[æ•°æ®åº“æŒ‡å—](./03.database.md#a1-è”ç³»è¿ç»´åˆ›å»º-vault-role)ï¼‰ã€‚

**Policy ç¤ºä¾‹**ï¼š

```hcl
resource "vault_policy" "myapp" {
  name = "myapp"
  policy = <<-EOT
    path "secret/data/my-app/*" {
      capabilities = ["read"]
    }
  EOT
}
```

æ³¨æ„ï¼šä½¿ç”¨ `my-app/*` é€šé…ç¬¦ï¼Œè¿™æ ·æ‰€æœ‰ `secret/data/my-app/` ä¸‹çš„å¯†é’¥éƒ½å¯ä»¥è®¿é—®ã€‚

### æ­¥éª¤ 4: åœ¨åº”ç”¨ä¸­æ³¨å…¥å¯†é’¥

åœ¨ Deployment æ·»åŠ  Vault annotationsï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "myapp"
        # OpenAI API Key
        vault.hashicorp.com/agent-inject-secret-openai: "secret/data/my-app/openai"
        vault.hashicorp.com/agent-inject-template-openai: |
          {{- with secret "secret/data/my-app/openai" -}}
          export OPENAI_API_KEY="{{ .Data.data.api_key }}"
          export OPENAI_ORG_ID="{{ .Data.data.organization_id }}"
          {{- end }}
    spec:
      serviceAccountName: my-app
      containers:
      - name: my-app
        command: ["/bin/sh", "-c"]
        args:
          - |
            source /vault/secrets/openai
            exec node server.js
```

### æ­¥éª¤ 5: åœ¨ä»£ç ä¸­ä½¿ç”¨

**Node.js ç¤ºä¾‹**ï¼š

```javascript
const { Configuration, OpenAIApi } = require("openai");

const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY,
  organization: process.env.OPENAI_ORG_ID,
});

const openai = new OpenAIApi(configuration);
```

---

## å¤šä¸ªå¯†é’¥çš„ç®¡ç†

### æ–¹å¼ 1: å•ä¸ª Secret åŒ…å«å¤šä¸ª Key

**Vault å­˜å‚¨**ï¼š
```json
// secret/data/my-app/api-keys
{
  "openai_api_key": "sk-xxx",
  "stripe_secret_key": "sk_test_xxx",
  "sendgrid_api_key": "SG.xxx"
}
```

**Annotations**ï¼š
```yaml
vault.hashicorp.com/agent-inject-secret-api-keys: "secret/data/my-app/api-keys"
vault.hashicorp.com/agent-inject-template-api-keys: |
  {{- with secret "secret/data/my-app/api-keys" -}}
  export OPENAI_API_KEY="{{ .Data.data.openai_api_key }}"
  export STRIPE_SECRET_KEY="{{ .Data.data.stripe_secret_key }}"
  export SENDGRID_API_KEY="{{ .Data.data.sendgrid_api_key }}"
  {{- end }}
```

### æ–¹å¼ 2: æŒ‰æœåŠ¡åˆ†ç¦» Secret

**Vault å­˜å‚¨**ï¼š
```
secret/data/my-app/openai
secret/data/my-app/stripe
secret/data/my-app/sendgrid
```

**Annotations**ï¼š
```yaml
# OpenAI
vault.hashicorp.com/agent-inject-secret-openai: "secret/data/my-app/openai"
vault.hashicorp.com/agent-inject-template-openai: |
  {{- with secret "secret/data/my-app/openai" -}}
  export OPENAI_API_KEY="{{ .Data.data.api_key }}"
  {{- end }}

# Stripe
vault.hashicorp.com/agent-inject-secret-stripe: "secret/data/my-app/stripe"
vault.hashicorp.com/agent-inject-template-stripe: |
  {{- with secret "secret/data/my-app/stripe" -}}
  export STRIPE_SECRET_KEY="{{ .Data.data.secret_key }}"
  {{- end }}

# SendGrid
vault.hashicorp.com/agent-inject-secret-sendgrid: "secret/data/my-app/sendgrid"
vault.hashicorp.com/agent-inject-template-sendgrid: |
  {{- with secret "secret/data/my-app/sendgrid" -}}
  export SENDGRID_API_KEY="{{ .Data.data.api_key }}"
  {{- end }}
```

**æ¨è**ï¼šæ–¹å¼ 2 æ›´æ¸…æ™°ï¼Œä½†ä¼šå¢åŠ  annotations æ•°é‡ã€‚å¯¹äºå¯†é’¥è¾ƒå°‘çš„åº”ç”¨ï¼Œæ–¹å¼ 1 æ›´ç®€æ´ã€‚

---

## å¯†é’¥è½®æ¢ {#å¯†é’¥è½®æ¢}

### åœºæ™¯ï¼šAPI Key æ³„éœ²ï¼Œéœ€è¦æ›´æ–°

**æ­¥éª¤ 1: åœ¨ Vault æ›´æ–°å¯†é’¥**

é€šè¿‡ Vault UI æˆ–è”ç³»è¿ç»´æ›´æ–°å¯¹åº” secret çš„å€¼ã€‚

**æ­¥éª¤ 2: é‡å¯åº”ç”¨ Pod**

Vault Agent åœ¨ Pod å¯åŠ¨æ—¶æ³¨å…¥å¯†é’¥ï¼Œéœ€è¦é‡å¯æ‰èƒ½åŠ è½½æ–°å€¼ï¼š

```bash
kubectl rollout restart deployment/my-app -n apps-staging
```

**æ­¥éª¤ 3: éªŒè¯æ–°å¯†é’¥**

æŸ¥çœ‹ Pod æ—¥å¿—ç¡®è®¤ä½¿ç”¨äº†æ–°çš„ API Keyã€‚

---

## é…ç½®æ–‡ä»¶ç±»å¯†é’¥

### åœºæ™¯ï¼šéœ€è¦æ³¨å…¥ JSON é…ç½®æ–‡ä»¶

ä¾‹å¦‚ Google Cloud Service Account Keyï¼ˆJSON æ ¼å¼ï¼‰ã€‚

**Vault å­˜å‚¨**ï¼š
```json
// secret/data/my-app/gcp-sa
{
  "key_json": "{\"type\":\"service_account\",\"project_id\":\"xxx\",...}"
}
```

**Annotations**ï¼ˆæ³¨å…¥ä¸ºæ–‡ä»¶ï¼‰ï¼š

```yaml
vault.hashicorp.com/agent-inject-secret-gcp-sa: "secret/data/my-app/gcp-sa"
vault.hashicorp.com/agent-inject-template-gcp-sa: |
  {{- with secret "secret/data/my-app/gcp-sa" -}}
  {{ .Data.data.key_json }}
  {{- end }}
```

**åº”ç”¨ä¸­ä½¿ç”¨**ï¼š

```javascript
const { GoogleAuth } = require('google-auth-library');

const auth = new GoogleAuth({
  keyFilename: '/vault/secrets/gcp-sa',
});
```

---

## ç¯å¢ƒç‰¹å®šå¯†é’¥

### Staging å’Œ Prod ä½¿ç”¨ä¸åŒçš„ API Key

**Vault è·¯å¾„è§„åˆ’**ï¼š
```
secret/data/my-app/staging/openai
secret/data/my-app/prod/openai
```

**æ–¹å¼ 1: åœ¨ Annotations ä¸­ç¡¬ç¼–ç ç¯å¢ƒ**

Staging Deployment:
```yaml
vault.hashicorp.com/agent-inject-secret-openai: "secret/data/my-app/staging/openai"
```

Prod Deployment:
```yaml
vault.hashicorp.com/agent-inject-secret-openai: "secret/data/my-app/prod/openai"
```

**æ–¹å¼ 2: ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼ˆæ¨èï¼‰

åœ¨ Vault template ä¸­è¯»å–ç¯å¢ƒå˜é‡ï¼š

```yaml
vault.hashicorp.com/agent-inject-template-openai: |
  {{- with secret (printf "secret/data/my-app/%s/openai" (env "ENVIRONMENT")) -}}
  export OPENAI_API_KEY="{{ .Data.data.api_key }}"
  {{- end }}
```

åœ¨ Kubero è®¾ç½®ç¯å¢ƒå˜é‡ `ENVIRONMENT=staging` æˆ– `ENVIRONMENT=prod`ã€‚

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ— æ³•è¯»å–å¯†é’¥ - permission denied

**é”™è¯¯æ—¥å¿—**ï¼š
```
Error: permission denied at path "secret/data/my-app/openai"
```

**åŸå› **ï¼šVault Policy æœªæˆæƒè¯¥è·¯å¾„ã€‚

**è§£å†³**ï¼š
1. æ£€æŸ¥ Policy é…ç½®æ˜¯å¦åŒ…å«è¯¥è·¯å¾„
2. ç¡®è®¤è·¯å¾„æ‹¼å†™æ­£ç¡®ï¼ˆæ³¨æ„ `secret/data/` å‰ç¼€ï¼‰
3. è”ç³»è¿ç»´æ›´æ–° Policy

### é—®é¢˜ 2: å¯†é’¥æ–‡ä»¶ä¸ºç©º

**åŸå› **ï¼šTemplate è¯­æ³•é”™è¯¯æˆ– Secret ä¸å­˜åœ¨ã€‚

**æ’æŸ¥**ï¼š
1. æŸ¥çœ‹ Vault Agent init æ—¥å¿—ï¼š
   ```bash
   kubectl logs <pod-name> -c vault-agent-init
   ```
2. åœ¨ Vault UI éªŒè¯ Secret å­˜åœ¨
3. æ£€æŸ¥ Template è¯­æ³•ï¼ˆGo templateï¼‰

### é—®é¢˜ 3: å¯†é’¥æ›´æ–°ååº”ç”¨ä»ç”¨æ—§å€¼

**åŸå› **ï¼šVault Agent åªåœ¨ Pod å¯åŠ¨æ—¶æ³¨å…¥ä¸€æ¬¡ã€‚

**è§£å†³**ï¼šé‡å¯ Deploymentï¼ˆè§[å¯†é’¥è½®æ¢](#å¯†é’¥è½®æ¢)ï¼‰ã€‚

### é—®é¢˜ 4: Vault UI ç™»å½•åçœ‹ä¸åˆ°å¯†é’¥

**åŸå› **ï¼šPolicy æœªæˆæƒæˆ–ä½¿ç”¨äº†é”™è¯¯çš„ Roleã€‚

**è§£å†³**ï¼š
1. ä½¿ç”¨ OIDC ç™»å½•æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥ role nameï¼ˆå¦‚ `reader`ï¼‰
2. ç¡®è®¤è¯¥ Role çš„ Policy åŒ…å«æ‰€éœ€è·¯å¾„
3. è”ç³»è¿ç»´æ£€æŸ¥æƒé™é…ç½®

---

## æœ€ä½³å®è·µ

### 1. å¯†é’¥è·¯å¾„å‘½åè§„èŒƒ

æ¨èç»“æ„ï¼š
```
secret/data/<app-name>/<environment>/<service>
```

ç¤ºä¾‹ï¼š
```
secret/data/my-app/prod/openai
secret/data/my-app/staging/stripe
secret/data/backend/prod/jwt-secret
```

### 2. æœ€å°æƒé™åŸåˆ™

æ¯ä¸ªåº”ç”¨çš„ Policy åªæˆæƒå¿…éœ€çš„è·¯å¾„ï¼š

```hcl
# å¥½çš„å®è·µ
path "secret/data/my-app/*" {
  capabilities = ["read"]
}

# ä¸æ¨è
path "secret/data/*" {
  capabilities = ["read"]
}
```

### 3. é¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 

âŒ **é”™è¯¯åšæ³•**ï¼š
```javascript
const apiKey = "sk-xxxxxxxxxx"; // ç¡¬ç¼–ç 
```

âœ… **æ­£ç¡®åšæ³•**ï¼š
```javascript
const apiKey = process.env.OPENAI_API_KEY; // ä»ç¯å¢ƒå˜é‡è¯»å–
```

### 4. ä½¿ç”¨é…ç½®æ–‡ä»¶æ¨¡æ¿

å¯¹äºå¤æ‚é…ç½®ï¼Œä½¿ç”¨ Vault template ç”Ÿæˆå®Œæ•´é…ç½®æ–‡ä»¶ï¼š

```yaml
vault.hashicorp.com/agent-inject-template-config: |
  {{- with secret "secret/data/my-app/config" -}}
  {
    "database": {
      "host": "{{ .Data.data.db_host }}",
      "password": "{{ .Data.data.db_password }}"
    },
    "api": {
      "key": "{{ .Data.data.api_key }}"
    }
  }
  {{- end }}
```

---

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ çš„åº”ç”¨å¯ä»¥å®‰å…¨åœ°ç®¡ç†å¯†é’¥äº†ï¼ğŸ‰

æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œç»§ç»­æ¢ç´¢ï¼š

| éœ€æ±‚ | ä¸‹ä¸€æ­¥é˜…è¯» |
|------|----------|
| **éœ€è¦ç”¨æˆ·ç™»å½•åŠŸèƒ½** | [æ¥å…¥ SSO](./05.sso.md) |
| **éœ€è¦ç›‘æ§å’Œæ—¥å¿—** | [ç›‘æ§å’Œåˆ†æ](./06.observability.md) |

---

## å‚è€ƒ

- **Vault æ¶æ„è¯¦è§£** - [platform.secrets.md](../ssot/platform.secrets.md)
- **Vault æ¥å…¥æœºåˆ¶** - [db.vault-integration.md](../ssot/db.vault-integration.md)
- **è®¤è¯ä¸æˆæƒ** - [platform.auth.md](../ssot/platform.auth.md)

---

*Last updated: 2025-12-21*
