# ä½¿ç”¨æ•°æ®åº“

> **åœºæ™¯**ï¼šåº”ç”¨éœ€è¦è¿æ¥æ•°æ®åº“ï¼ˆPostgreSQLã€Redisã€ClickHouseã€ArangoDBï¼‰
> **é¢„è®¡æ—¶é—´**ï¼š30 åˆ†é’Ÿ
> **å‰ç½®æ¡ä»¶**ï¼šå·²å®Œæˆ[éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨](./02.first-app.md)

---

## æ¦‚è¿°

å¹³å°æä¾›çš„æ•°æ®åº“æœåŠ¡ï¼š

| æ•°æ®åº“ | ç”¨é€” | è®¿é—®æ–¹å¼ |
|--------|------|---------|
| **PostgreSQL** | å…³ç³»æ•°æ®åº“ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰ | Vault é™æ€å¯†ç  |
| **Redis** | ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ— | Vault é™æ€å¯†ç  |
| **ClickHouse** | OLAP åˆ†æ | Vault é™æ€å¯†ç  |
| **ArangoDB** | å›¾æ•°æ®åº“ | Vault é™æ€å¯†ç  |

**æ ¸å¿ƒæœºåˆ¶**ï¼šæ‰€æœ‰æ•°æ®åº“å¯†ç å­˜å‚¨åœ¨ **Vault**ï¼Œé€šè¿‡ **Kubernetes ServiceAccount + Vault Agent** è‡ªåŠ¨æ³¨å…¥åˆ°åº”ç”¨ Podã€‚

---

## å¿«é€Ÿé€‰æ‹©åœºæ™¯

æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œç›´æ¥è·³åˆ°å¯¹åº”åœºæ™¯ï¼š

| åº”ç”¨ç±»å‹ | æ¨èæ•°æ®åº“ | è·³è½¬ |
|---------|-----------|------|
| **Web åº”ç”¨** | PostgreSQL | [åœºæ™¯ A](#åœºæ™¯-a-web-åº”ç”¨--postgresql) |
| **éœ€è¦ç¼“å­˜çš„ Web åº”ç”¨** | PostgreSQL + Redis | [åœºæ™¯ B](#åœºæ™¯-b-web-åº”ç”¨--ç¼“å­˜) |
| **æ•°æ®åˆ†æåº”ç”¨** | PostgreSQL + ClickHouse | [åœºæ™¯ C](#åœºæ™¯-c-æ•°æ®åˆ†æåº”ç”¨) |
| **å›¾æ•°æ®åº”ç”¨** | ArangoDB | [åœºæ™¯ D](#åœºæ™¯-d-å›¾æ•°æ®åº”ç”¨) |

---

## æ•°æ®åº“è¿æ¥ä¿¡æ¯

### PostgreSQL (Business)

| å±æ€§ | å€¼ |
|------|-----|
| **æœåŠ¡åœ°å€** | `postgresql.data-<env>.svc.cluster.local:5432` |
| **æ•°æ®åº“å** | `business` |
| **Vault è·¯å¾„** | `secret/data/postgres` |

**ç¤ºä¾‹è¿æ¥å­—ç¬¦ä¸²**ï¼š
```
postgresql://user:password@postgresql.data-staging.svc.cluster.local:5432/business
```

### Redis

| å±æ€§ | å€¼ |
|------|-----|
| **æœåŠ¡åœ°å€** | `redis-master.data-<env>.svc.cluster.local:6379` |
| **Vault è·¯å¾„** | `secret/data/redis` |

### ClickHouse

| å±æ€§ | å€¼ |
|------|-----|
| **HTTP ç«¯å£** | `8123` |
| **Native ç«¯å£** | `9000` |
| **æœåŠ¡åœ°å€** | `clickhouse.data-<env>.svc.cluster.local` |
| **Vault è·¯å¾„** | `secret/data/clickhouse` |

### ArangoDB

| å±æ€§ | å€¼ |
|------|-----|
| **æœåŠ¡åœ°å€** | `arangodb.data-<env>.svc.cluster.local:8529` |
| **Vault è·¯å¾„** | `secret/data/arangodb` |

**æ³¨æ„**ï¼š`<env>` ä¸º `staging` æˆ– `prod`ï¼Œæ ¹æ®ä½ çš„éƒ¨ç½²ç¯å¢ƒæ›¿æ¢ã€‚

---

## åœºæ™¯ A: Web åº”ç”¨ + PostgreSQL

### A1. è”ç³»è¿ç»´åˆ›å»º Vault Role

**ä½ éœ€è¦æä¾›**ï¼š
- åº”ç”¨åç§°ï¼š`my-app`
- ServiceAccount åç§°ï¼š`my-app`
- Namespaceï¼š`apps-staging`
- éœ€è¦è®¿é—®çš„å¯†é’¥ï¼š`secret/data/postgres`

**è¿ç»´ä¼šåš**ï¼š
åœ¨ `2.platform/` åˆ›å»ºç±»ä¼¼å¦‚ä¸‹çš„ Terraform é…ç½®ï¼š

```hcl
# 2.platform/92.vault-myapp.tf

resource "vault_policy" "myapp" {
  name = "myapp"
  policy = <<-EOT
    path "secret/data/postgres" {
      capabilities = ["read"]
    }
  EOT
}

resource "vault_kubernetes_auth_backend_role" "myapp" {
  backend                          = vault_auth_backend.kubernetes.path
  role_name                        = "myapp"
  bound_service_account_names      = ["my-app"]
  bound_service_account_namespaces = ["apps-staging", "apps-prod"]
  token_policies                   = ["myapp"]
  token_ttl                        = 3600
}
```

### A2. åœ¨ Kubero é…ç½® Vault Annotations

åœ¨ä½ çš„ Deployment YAML ä¸­ï¼ˆæˆ–é€šè¿‡ Kubero UI é…ç½®ï¼‰æ·»åŠ  annotationsï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "myapp"
        vault.hashicorp.com/agent-inject-secret-pg: "secret/data/postgres"
        vault.hashicorp.com/agent-inject-template-pg: |
          {{- with secret "secret/data/postgres" -}}
          export PGHOST="{{ .Data.data.host }}"
          export PGPORT="{{ .Data.data.port }}"
          export PGUSER="{{ .Data.data.username }}"
          export PGPASSWORD="{{ .Data.data.password }}"
          export PGDATABASE="{{ .Data.data.database }}"
          {{- end }}
    spec:
      serviceAccountName: my-app
      containers:
      - name: my-app
        image: your-image
        command: ["/bin/sh", "-c"]
        args:
          - |
            source /vault/secrets/pg
            exec node server.js
```

**å…³é”®ç‚¹**ï¼š
1. `serviceAccountName` å¿…é¡»åŒ¹é… Vault Role é…ç½®
2. `vault.hashicorp.com/role` æŒ‡å®š Vault role åç§°
3. Template å°†å¯†é’¥æ¸²æŸ“ä¸ºç¯å¢ƒå˜é‡å¯¼å‡ºè¯­å¥
4. å¯åŠ¨è„šæœ¬å…ˆ `source /vault/secrets/pg` å†å¯åŠ¨åº”ç”¨

### A3. åº”ç”¨ä»£ç è¯»å–ç¯å¢ƒå˜é‡

**Node.js ç¤ºä¾‹**ï¼š

```javascript
const { Pool } = require('pg');

const pool = new Pool({
  host: process.env.PGHOST,
  port: process.env.PGPORT,
  user: process.env.PGUSER,
  password: process.env.PGPASSWORD,
  database: process.env.PGDATABASE,
});

// æµ‹è¯•è¿æ¥
pool.query('SELECT NOW()', (err, res) => {
  if (err) {
    console.error('Database connection failed:', err);
  } else {
    console.log('Database connected:', res.rows[0]);
  }
});
```

**Python ç¤ºä¾‹**ï¼š

```python
import os
import psycopg2

conn = psycopg2.connect(
    host=os.environ['PGHOST'],
    port=os.environ['PGPORT'],
    user=os.environ['PGUSER'],
    password=os.environ['PGPASSWORD'],
    database=os.environ['PGDATABASE']
)
```

### A4. éƒ¨ç½²å’ŒéªŒè¯

1. **éƒ¨ç½²åº”ç”¨**ï¼ˆKubero ä¼šè‡ªåŠ¨é‡æ–°éƒ¨ç½²ï¼‰
2. **æŸ¥çœ‹æ—¥å¿—**ï¼šåº”è¯¥çœ‹åˆ° "Database connected" æ¶ˆæ¯
3. **éªŒè¯ Vault æ³¨å…¥**ï¼š
   ```bash
   kubectl exec -it <pod-name> -n apps-staging -- cat /vault/secrets/pg
   ```
   åº”è¯¥çœ‹åˆ°å¯¼å‡ºçš„ç¯å¢ƒå˜é‡ã€‚

---

## åœºæ™¯ B: Web åº”ç”¨ + ç¼“å­˜

éœ€è¦åŒæ—¶ä½¿ç”¨ PostgreSQL å’Œ Redisã€‚

### B1. æ‰©å±• Vault Policy

```hcl
resource "vault_policy" "myapp" {
  name = "myapp"
  policy = <<-EOT
    path "secret/data/postgres" {
      capabilities = ["read"]
    }
    path "secret/data/redis" {
      capabilities = ["read"]
    }
  EOT
}
```

### B2. æ·»åŠ  Redis annotations

```yaml
annotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/role: "myapp"
  # PostgreSQL
  vault.hashicorp.com/agent-inject-secret-pg: "secret/data/postgres"
  vault.hashicorp.com/agent-inject-template-pg: |
    {{- with secret "secret/data/postgres" -}}
    export PGHOST="{{ .Data.data.host }}"
    export PGPORT="{{ .Data.data.port }}"
    export PGUSER="{{ .Data.data.username }}"
    export PGPASSWORD="{{ .Data.data.password }}"
    export PGDATABASE="{{ .Data.data.database }}"
    {{- end }}
  # Redis
  vault.hashicorp.com/agent-inject-secret-redis: "secret/data/redis"
  vault.hashicorp.com/agent-inject-template-redis: |
    {{- with secret "secret/data/redis" -}}
    export REDIS_HOST="{{ .Data.data.host }}"
    export REDIS_PORT="{{ .Data.data.port }}"
    export REDIS_PASSWORD="{{ .Data.data.password }}"
    {{- end }}
```

### B3. åº”ç”¨ä»£ç 

**Node.js Redis è¿æ¥**ï¼š

```javascript
const Redis = require('ioredis');

const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: process.env.REDIS_PORT,
  password: process.env.REDIS_PASSWORD,
});

redis.on('connect', () => {
  console.log('Redis connected');
});
```

---

## åœºæ™¯ C: æ•°æ®åˆ†æåº”ç”¨

ä½¿ç”¨ PostgreSQL å­˜å‚¨æ•°æ® + ClickHouse åš OLAP åˆ†æã€‚

å‚è€ƒåœºæ™¯ B çš„æ¨¡å¼ï¼ŒåŒæ—¶æ·»åŠ  ClickHouse secretï¼š

```yaml
vault.hashicorp.com/agent-inject-secret-ch: "secret/data/clickhouse"
vault.hashicorp.com/agent-inject-template-ch: |
  {{- with secret "secret/data/clickhouse" -}}
  export CLICKHOUSE_HOST="{{ .Data.data.host }}"
  export CLICKHOUSE_PORT="{{ .Data.data.port }}"
  export CLICKHOUSE_PASSWORD="{{ .Data.data.password }}"
  {{- end }}
```

---

## åœºæ™¯ D: å›¾æ•°æ®åº”ç”¨

ä½¿ç”¨ ArangoDBã€‚

```yaml
vault.hashicorp.com/agent-inject-secret-arango: "secret/data/arangodb"
vault.hashicorp.com/agent-inject-template-arango: |
  {{- with secret "secret/data/arangodb" -}}
  export ARANGO_HOST="{{ .Data.data.host }}"
  export ARANGO_PORT="{{ .Data.data.port }}"
  export ARANGO_PASSWORD="{{ .Data.data.password }}"
  {{- end }}
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Pod å¯åŠ¨å¤±è´¥ - permission denied

**é”™è¯¯æ—¥å¿—**ï¼š
```
Error: vault.hashicorp.com/agent-inject: permission denied
```

**åŸå› **ï¼šVault Role æœªæ­£ç¡®é…ç½®æˆ– ServiceAccount ä¸åŒ¹é…ã€‚

**æ’æŸ¥**ï¼š
1. ç¡®è®¤ ServiceAccount åç§°æ­£ç¡®
2. è”ç³»è¿ç»´æ£€æŸ¥ Vault Role é…ç½®ï¼š
   ```bash
   vault read auth/kubernetes/role/myapp
   ```

### é—®é¢˜ 2: Secret æ–‡ä»¶ä¸ºç©º

**æ’æŸ¥**ï¼š
1. æŸ¥çœ‹ Vault Agent init å®¹å™¨æ—¥å¿—ï¼š
   ```bash
   kubectl logs <pod-name> -c vault-agent-init -n apps-staging
   ```
2. ç¡®è®¤ Vault secret è·¯å¾„å­˜åœ¨ï¼š
   ```bash
   vault kv get secret/data/postgres
   ```

### é—®é¢˜ 3: åº”ç”¨è¿æ¥æ•°æ®åº“å¤±è´¥

**é”™è¯¯**ï¼š`connection refused` æˆ– `could not connect to server`

**æ’æŸ¥**ï¼š
1. ç¡®è®¤æ•°æ®åº“æœåŠ¡åœ¨å¯¹åº” namespace è¿è¡Œï¼š
   ```bash
   kubectl get svc -n data-staging
   ```
2. ç¡®è®¤æœåŠ¡åœ°å€æ‹¼å†™æ­£ç¡®ï¼ˆæ³¨æ„ `<env>` æ›¿æ¢ï¼‰
3. åœ¨ Pod å†…æµ‹è¯•è¿æ¥ï¼š
   ```bash
   kubectl exec -it <pod-name> -n apps-staging -- \
     psql -h postgresql.data-staging.svc.cluster.local -U postgres
   ```

### é—®é¢˜ 4: Vault Agent æŠ¥é”™ - token expired

**åŸå› **ï¼šToken TTL è¿‡çŸ­æˆ– Agent æœªæ­£ç¡®ç»­æœŸã€‚

**è§£å†³**ï¼šè”ç³»è¿ç»´è°ƒæ•´ Vault Role çš„ `token_ttl` é…ç½®ã€‚

---

## ç¯å¢ƒéš”ç¦»æ³¨æ„äº‹é¡¹

### Staging vs Prod æ•°æ®åº“å®Œå…¨ç‹¬ç«‹

- `apps-staging` ä½¿ç”¨ `data-staging` namespace çš„æ•°æ®åº“
- `apps-prod` ä½¿ç”¨ `data-prod` namespace çš„æ•°æ®åº“
- **æ•°æ®ä¸ä¼šè‡ªåŠ¨åŒæ­¥**

### å¦‚ä½•åœ¨ç¯å¢ƒé—´è¿ç§»æ•°æ®ï¼Ÿ

**æ–¹å¼ 1: ä½¿ç”¨å¤‡ä»½æ¢å¤**
```bash
# Staging å¯¼å‡º
kubectl exec -n data-staging postgresql-0 -- \
  pg_dump -U postgres business > staging_backup.sql

# Prod å¯¼å…¥
kubectl exec -i -n data-prod postgresql-0 -- \
  psql -U postgres business < staging_backup.sql
```

**æ–¹å¼ 2: ä½¿ç”¨æ•°æ®åŒæ­¥å·¥å…·**ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
- æ ¹æ®éœ€è¦é…ç½® ETL pipeline
- è”ç³»è¿ç»´å›¢é˜ŸååŠ©

---

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ çš„åº”ç”¨å¯ä»¥ä½¿ç”¨æ•°æ®åº“äº†ï¼ğŸ‰

æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œç»§ç»­æ¢ç´¢ï¼š

| éœ€æ±‚ | ä¸‹ä¸€æ­¥é˜…è¯» |
|------|----------|
| **ç®¡ç†å…¶ä»–å¯†é’¥ï¼ˆAPI Keys ç­‰ï¼‰** | [ç®¡ç†å¯†é’¥](./04.secrets.md) |
| **éœ€è¦ç”¨æˆ·ç™»å½•åŠŸèƒ½** | [æ¥å…¥ SSO](./05.sso.md) |
| **éœ€è¦ç›‘æ§æ•°æ®åº“æŸ¥è¯¢** | [ç›‘æ§å’Œåˆ†æ](./06.observability.md) |

---

## å‚è€ƒ

- **æ•°æ®åº“è¯¦ç»†è¯´æ˜** - [db.overview.md](../ssot/db.overview.md)
- **Vault æ¥å…¥æœºåˆ¶** - [db.vault-integration.md](../ssot/db.vault-integration.md)
- **Vault ç¤ºä¾‹é…ç½®** - [92.vault-kubero.tf](../../2.platform/92.vault-kubero.tf)

---

*Last updated: 2025-12-21*
