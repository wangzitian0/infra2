# æ–°å¢æœåŠ¡ SOP (Standard Operating Procedure)

> **ç”¨é€”**ï¼šæ–°æœåŠ¡ä¸Šçº¿çš„æ ‡å‡†æ£€æŸ¥æ¸…å•
> **é€‚ç”¨å¯¹è±¡**ï¼šåŸºç¡€è®¾æ–½ç»´æŠ¤è€…

---

## ğŸš€ æ–°æœåŠ¡ä¸Šçº¿æ£€æŸ¥æ¸…å•

### 1. ä»£ç ç»“æ„éªŒè¯

ç¡®ä¿æ–°æœåŠ¡ç›®å½•åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

| æ–‡ä»¶ | å¿…éœ€ | ç”¨é€” |
|------|------|------|
| `compose.yaml` | âœ… | Docker Compose é…ç½® |
| `deploy.py` | âœ… | Deployer ç±» + invoke tasks |
| `shared_tasks.py` | âœ… | status() å¥åº·æ£€æŸ¥ |
| `vault-agent.hcl` | âœ… | Vault Agent é…ç½® |
| `secrets.ctmpl` | âœ… | Secrets æ¨¡æ¿ |
| `vault-policy.hcl` | âš ï¸ | Vault ç­–ç•¥ï¼ˆå¯é€‰ï¼Œæœ‰é»˜è®¤ï¼‰ |
| `README.md` | âœ… | æœåŠ¡æ–‡æ¡£ |

### 2. Vault Secrets é…ç½®

```bash
# 1. å­˜å‚¨æœåŠ¡æ‰€éœ€çš„å¯†é’¥
invoke env.set <KEY>=<VALUE> --project=<project> --service=<service>

# 2. ç”Ÿæˆ VAULT_APP_TOKEN
export VAULT_ROOT_TOKEN=$(op read 'op://Infra2/.../Token')
invoke vault.setup-tokens

# 3. éªŒè¯ token å·²å†™å…¥ Dokploy
# (setup-tokens ä¼šè‡ªåŠ¨é…ç½®ï¼Œæ£€æŸ¥ Dokploy UI ç¡®è®¤)
```

### 3. IaC é›†æˆéªŒè¯

**ä»…é€‚ç”¨äº `platform` é¡¹ç›®æœåŠ¡** (IaC Runner ç®¡ç†èŒƒå›´)

```bash
# éªŒè¯æœåŠ¡è¢« discover_services() å‘ç°
python -c "
import sys
sys.path.insert(0, 'libs')
from deployer import discover_services
services = discover_services()
print('Discovered services:')
for k, v in sorted(services.items()):
    print(f'  {k} -> {v}')
"
```

ç¡®ä¿æ–°æœåŠ¡å‡ºç°åœ¨åˆ—è¡¨ä¸­ï¼Œæ ¼å¼ä¸ºï¼š
- `platform/<service>` â†’ `<service>.sync` (ç”± IaC Runner è‡ªåŠ¨åŒæ­¥)
- `finance_report/<service>` â†’ `fr-<service>.sync` (ä½¿ç”¨åº”ç”¨ CI)
- `bootstrap/<service>` â†’ `<service>.sync` (æ‰‹åŠ¨éƒ¨ç½²)

### 4. éƒ¨ç½²éªŒè¯

```bash
# éƒ¨ç½²æœåŠ¡
invoke <service>.setup

# éªŒè¯å¥åº·çŠ¶æ€
invoke <service>.status

# æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€
ssh root@$VPS_HOST 'docker ps | grep <container-name>'
```

### 5. çº¿ä¸Šå¥åº·æ£€æŸ¥

```bash
# HTTP å¥åº·ç«¯ç‚¹
curl -s https://<subdomain>.zitian.party/health

# æˆ–æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
ssh root@$VPS_HOST 'docker inspect <container> --format "{{.State.Health.Status}}"'
```

### 6. Post-Merge CI éªŒè¯

**ä»…é€‚ç”¨äº `platform` é¡¹ç›®æœåŠ¡** (IaC Runner ä¸ç®¡ç† bootstrap å’Œåº”ç”¨å±‚)

éªŒè¯ GitHub Webhook å’Œ IaC Runner èƒ½æ­£ç¡®è§¦å‘åŒæ­¥ï¼š

1. **IaC Runner å¥åº·æ£€æŸ¥**
   ```bash
   curl -s https://iac.zitian.party/health
   # æœŸæœ›: {"status": "healthy"}
   ```

2. **æµ‹è¯• Webhook** (platform æœåŠ¡)
   ```bash
   # æ¨é€ä¸€ä¸ªå°å˜æ›´åˆ° main (e.g., ä¿®æ”¹ platform/XX.service/README.md)
   git commit -am "test: trigger iac-runner webhook"
   git push origin main
   
   # è§‚å¯Ÿ IaC Runner æ—¥å¿—
   ssh root@$VPS_HOST "docker logs iac-runner -f"
   
   # æœŸæœ›æ—¥å¿—:
   # "Webhook received"
   # "Changed files: platform/XX.service/README.md"
   # "Running: invoke <service>.sync"
   # "âœ“ Config hash unchanged, skipping deploy" (æˆ– "âœ“ Deployed successfully")
   ```

3. **æ‰‹åŠ¨åŒæ­¥æµ‹è¯•**
   ```bash
   # ä½¿ç”¨ invoke ç›´æ¥åŒæ­¥
   invoke <service>.sync
   
   # æœŸæœ›è¾“å‡º:
   # "Checking config hash..."
   # "âœ“ Config hash unchanged, skipping deploy" (å¹‚ç­‰æ€§éªŒè¯)
   ```

4. **éªŒè¯ config hash å¹‚ç­‰æ€§**
   ```bash
   # å¤šæ¬¡è¿è¡Œ syncï¼Œåº”è¯¥å…¨éƒ¨è·³è¿‡ (no-op)
   invoke <service>.sync
   invoke <service>.sync
   invoke <service>.sync
   ```

**æ³¨æ„äº‹é¡¹**ï¼š
- **Bootstrap æœåŠ¡** (vault, 1password, iac-runner) å¿…é¡»æ‰‹åŠ¨éƒ¨ç½²ï¼Œä¸èµ° IaC Runner
- **åº”ç”¨å±‚æœåŠ¡** (finance_report, wealthfolio) ä½¿ç”¨å„è‡ªçš„ GitHub CI/CDï¼Œä¸èµ° IaC Runner
- **Platform æœåŠ¡** (postgres, redis, authentik, etc.) æ‰ç”± IaC Runner è‡ªåŠ¨åŒæ­¥

### 7. æ–‡æ¡£æ›´æ–°

å®Œæˆä»¥ä¸‹æ–‡æ¡£æ›´æ–°ï¼š

- [ ] æœåŠ¡ README.md
- [ ] å¦‚æœæ˜¯æ–°é¡¹ç›®ï¼Œæ›´æ–° `vault.setup-tokens` ä¸­çš„ projects åˆ—è¡¨
- [ ] æ›´æ–° `sync_runner.py` ä¸­çš„ `SERVICE_TASK_MAP` (å¦‚éœ€æ‰‹åŠ¨æ˜ å°„)
- [ ] æ›´æ–°ç›¸å…³ SSOT æ–‡æ¡£

---

## ğŸ“‹ å¿«é€Ÿæ¨¡æ¿

### deploy.py æ¨¡æ¿

```python
import sys
from libs.deployer import Deployer, make_tasks

shared_tasks = sys.modules.get("platform.XX.new.shared")

class NewDeployer(Deployer):
    service = "new"
    compose_path = "platform/XX.new/compose.yaml"
    data_path = "/data/platform/new"
    secret_key = "password"
    
    # Domain config (set subdomain = None for SSO-protected services)
    subdomain = "new"
    service_port = 8080
    service_name = "server"

if shared_tasks:
    _tasks = make_tasks(NewDeployer, shared_tasks)
    status = _tasks["status"]
    pre_compose = _tasks["pre_compose"]
    composing = _tasks["composing"]
    post_compose = _tasks["post_compose"]
    setup = _tasks["setup"]
    sync = _tasks["sync"]
```

### shared_tasks.py æ¨¡æ¿

```python
from invoke import task
from libs.common import check_service

@task
def status(c):
    return check_service(c, "new", "health-cmd")
```

### vault-agent.hcl æ¨¡æ¿

```hcl
vault {}

auto_auth {
  method {
    type = "token_file"
    config = {
      token_file_path = "/vault/token"
    }
  }

  sink {
    type = "file"
    config = {
      path = "/home/vault/.vault-token"
    }
  }
}

template_config {
  static_secret_render_interval = "5m"
}

template {
  source      = "/etc/vault/secrets.ctmpl"
  destination = "/vault/secrets/.env"
  perms       = 0644
}
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Platform README](../../platform/README.md) - æœåŠ¡æ·»åŠ æŒ‡å—
- [Vault Integration](../ssot/db.vault-integration.md) - Vault é›†æˆè¯¦è§£
- [IaC Runner](../../bootstrap/06.iac_runner/README.md) - GitOps åŒæ­¥æœºåˆ¶
- [Ops Pipeline](../ssot/ops.pipeline.md) - CI/CD æµæ°´çº¿

---
*Last updated: 2026-01-21*
